#' ---
#' title: "Yield gap analysis PUDT"
#' author: "Frédéric Baudron"
#' date: "7 décember 2024"
#' ---


# CLEAR ENVIRONMENT-------------------------------------------------------------

rm(list = ls())


# LOADING NECESSARY PACKAGES----------------------------------------------------

library(readxl)
library(janitor)
library(frontier)
library(geodata)
library(terra)
library(randomForest)


# SETTING UP THE DIRECTORY & LOADING THE DATA-----------------------------------

setwd("D:\\Mes Donnees\\1. Cirad\\PUDT\\Enquête\\")


plot = read_excel("Input_files//6.2. Champs.xlsx", sheet = 1)
manioc = read_excel("Input_files//6.4.1. Manioc.xlsx", sheet = 1)
typo = read_excel("Typo.xlsx", sheet = 1)

# DATA PREPARATION--------------------------------------------------------------

plot = plot[, c(1:3, 33:39, 47:79)]

manioc = manioc[, c(1, 66)]


# manioc$id = as.factor(manioc$id)

plot$manioc = ifelse(plot$manioc == "> 55% (culture principale)", 0.67, plot$manioc)
plot$manioc = ifelse(plot$manioc == "10-55% (culture associée)", 0.33, plot$manioc)
plot$manioc = ifelse(plot$manioc == "< 10% (culture mineure)", 0.05, plot$manioc)
plot$manioc = ifelse(plot$manioc == "absente (0%)", 0, plot$manioc)

names(plot)[4:15]

names(plot)[4:15] = c("surface", "jachere", "duree_jachère", "vegetation",
                  "duree_culture", "arbres_nonfruit", "foncier", "fumier", "engrais",
                  "pesticides", "herbicides", "sarclages")

manioc = merge(plot, manioc, by = "id", all.x = TRUE)

manioc$manioc = as.numeric(manioc$manioc)
manioc$manioc = manioc$manioc * manioc$surface

surf = aggregate(manioc ~ id, FUN = sum, na.rm = TRUE, data = manioc)

names(surf)[2] = "tot_surf_manioc"
names(manioc)[4] = "surf_manioc"

data = merge(manioc, surf, by = "id", all.x = TRUE)

data$prod_manioc = data$manioc_production * data$surf_manioc / data$tot_surf_manioc

data = data[!is.na(data$prod_manioc),]

data = subset(data, prod_manioc > 0)

data$yield_manioc = data$prod_manioc / data$surf_manioc

data = merge(data, typo, by = "id")


par(mar=c(5,5,5,5))

boxplot(data$yield_manioc)
data =  data[data$yield_manioc < 20000,]
boxplot(data$yield_manioc)

data$engrais = ifelse(data$engrais > 0, "Oui", "Non")
data$pesticides = ifelse(data$pesticides > 0, "Oui", "Non")


# STOCHASTIC FRONTIER ANALYSIS--------------------------------------------------

# Data transformations

data$log_yield_manioc = log(data$yield_manioc / mean(data$yield_manioc, na.rm=TRUE))
data$log_surface = log(data$surf_manioc / mean(data$surf_manioc, na.rm=TRUE))


# Explaining (in)efficiencies

names(data)

data$jachere

SFA = sfa(log_yield_manioc ~ as.factor(fumier) + as.factor(engrais) + as.factor(pesticides) +
            as.factor(sarclages) + as.factor(vegetation) + 
            as.factor(duree_jachère) + as.factor(arbres_nonfruit) + as.factor(destructions_animaux) +
            as.factor(pertes_climat) | 
            log_surface + foncier + departement + type3, data = data)

summary(SFA)


data$efficiency = efficiencies(SFA, asInData=TRUE)

data$techeff = data$yield_manioc / data$efficiency

mean(data$yield_manioc)
mean(data$techeff)
mean(data$efficiency)


quantile(data$yield_manioc, 0.9)
dataHFY = subset(data, yield_manioc > quantile(data$yield_manioc, 0.9))
HFY = mean(dataHFY$yield_manioc)

data$eff_yg = data$techeff - data$yield_manioc
mean(data$eff_yg)

data$res_yg = ifelse(HFY - data$techeff < 0, 0, HFY - data$techeff)
mean(data$res_yg)


plot(data$yield_manioc, data$eff_yg)
plot(data$yield_manioc, data$res_yg)


# SPATIAL PREDICTIONS-----------------------------------------------------------

# Load rasters

country = geodata::world(path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\admin-regions', resolution=5, level=0)
isocodes_ssa = c('COG')
ssa = subset(country, country$GID_0 %in% isocodes_ssa)

geosurvey = terra:: rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\cropland\\geosurvey_cropland.tif')
geosurvey = terra::crop(geosurvey, ssa)
geosurvey = terra::mask(geosurvey, ssa)
cs = cellSize(geosurvey, unit = "ha")
geosurvey_ha = cs * geosurvey 
geosurvey_ha = terra::aggregate(geosurvey_ha, 10)
names(geosurvey_ha) = 'geosurvey_ha'

pop_dens = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\population\\COG10adjv3.tif')
pop_dens = terra::crop(pop_dens, ssa)
pop_dens = terra::mask(pop_dens, ssa)
# pop_dens = pop_dens/100  # convert to person/km2
# pop_dens = terra::aggregate(pop_dens, 10)
pop_dens = terra::resample(pop_dens, geosurvey_ha)
names(pop_dens) = 'pop_dens'

elevation = geodata::elevation_30s("COG", path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\elevation')
elevation = terra::crop(elevation, ssa)
elevation = terra::mask(elevation, ssa)
elevation = terra::resample(elevation, geosurvey_ha)
names(elevation) = 'elevation'

rain = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\chirps-rainfall\\longterm-mean-yearly-rainfall.tif')
rain = terra::crop(rain, ssa)
rain = terra::mask(rain, ssa)
rain = terra::resample(rain, geosurvey_ha)
names(rain) = 'rain'

market = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\market-access\\MarketAccess.tif')
# market = terra::aggregate(market, 10)
market = terra::crop(market, ssa)
market = terra::mask(market, ssa)
market = terra::resample(market, geosurvey_ha)
names(market) = 'market'

soc_5 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_soc_0-5cm_30s.tif')
soc_15 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_soc_5-15cm_30s.tif')
soc_30 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_soc_15-30cm_30s.tif')
soc = (soc_5 * 5 + soc_15 * 10 + soc_30 * 15) / (5 + 10 + 15)
soc = terra::crop(soc, ssa)
soc = terra::mask(soc, ssa)
soc = terra::resample(soc, geosurvey_ha)
names(soc) = 'soc'

cec_5 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_cec_0-5cm_30s.tif')
cec_15 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_cec_5-15cm_30s.tif')
cec_30 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_cec_15-30cm_30s.tif')
cec = (cec_5 * 5 + cec_15 * 10 + cec_30 * 15) / (5 + 10 + 15)
cec = terra::crop(cec, ssa)
cec = terra::mask(cec, ssa)
cec = terra::resample(cec, geosurvey_ha)
names(cec) = 'cec'

ph_5 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_ph_0-5cm_30s.tif')
ph_15 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_ph_5-15cm_30s.tif')
ph_30 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_ph_15-30cm_30s.tif')
ph = (ph_5 * 5 + ph_15 * 10 + ph_30 * 15) / (5 + 10 + 15)
ph = terra::crop(ph, ssa)
ph = terra::mask(ph, ssa)
ph = terra::resample(ph, geosurvey_ha)
names(ph) = 'ph'

acid_exch_5 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_acid-exch_0-5cm_30s.tif')
acid_exch_15 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_acid-exch_5-15cm_30s.tif')
acid_exch_30 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_acid-exch_15-30cm_30s.tif')
acid_exch = (acid_exch_5 * 5 + acid_exch_15 * 10 + acid_exch_30 * 15) / (5 + 10 + 15)
acid_exch = terra::crop(acid_exch, ssa)
acid_exch = terra::mask(acid_exch, ssa)
acid_exch = terra::resample(acid_exch, geosurvey_ha)
names(acid_exch) = 'acid_exch'

sand_5 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_sand_0-5cm_30s.tif')
sand_15 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_sand_5-15cm_30s.tif')
sand_30 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_acid-exch_15-30cm_30s.tif')
sand = (sand_5 * 5 + sand_15 * 10 + sand_30 * 15) / (5 + 10 + 15)
sand = terra::crop(sand, ssa)
sand = terra::mask(sand, ssa)
sand = terra::resample(sand, geosurvey_ha)
names(sand) = 'sand'

veg = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\vegetation\\vegetation_modelled 6 Mar 2024.tiff')
veg = terra::crop(veg, ssa)
veg = terra::mask(veg, ssa)
veg = terra::resample(veg, geosurvey_ha)

lon = init(geosurvey_ha, 'x')
lon = terra::crop(lon, ssa)
lon = terra::mask(lon, ssa)
lon = terra::resample(lon, geosurvey_ha)
names(lon) = "longitude"

lat = init(geosurvey_ha, 'y')
lat = terra::crop(lat, ssa)
lat = terra::mask(lat, ssa)
lat = terra::resample(lat, geosurvey_ha)
names(lat) = "latitude"

stacked = c(geosurvey_ha, pop_dens, elevation, rain, market, soc, cec, ph, acid_exch,
            sand, veg, lon, lat)

plot(stacked)

cog = gadm(country = 'COG', level = 1, path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\admin-regions')


# df to spatial

data_spatial = data %>%
  sf::st_as_sf(coords = c("longitude", "latitude")) %>%
  sf::st_set_crs(4326)

# Merge dataset

data = cbind(data, terra::extract(stacked, terra::vect(data_spatial)))

data_rf = na.omit(data[, c(22, 25:28, 30:42)])


# Yield

rf_yield = randomForest(yield_manioc ~ geosurvey_ha + pop_dens + elevation + rain +
                           market + soc + cec + ph + acid_exch + sand + vegetation +
                           longitude + latitude, data = data_rf, ntree = 1500)
rf_yield$importance
rf_yield_pred = predict(stacked, rf_yield, na.rm = T)
plot(cog, col='lightgrey', main = "Prediction des rendements du manioc", panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(rf_yield_pred, legend = T, axes = F, add = T) 
plot(cog, axes = F, add = T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)


# Efficiency yield gap

rf_effyg = randomForest(eff_yg ~ geosurvey_ha + pop_dens + elevation + rain +
                          market + soc + cec + ph + acid_exch + sand + vegetation +
                          longitude + latitude, data = data_rf, ntree = 1500)
rf_effyg$importance
rf_effyg_pred = predict(stacked, rf_effyg, na.rm = T)
plot(cog, col='lightgrey', main = "Prediction des écarts de rendement d'efficience du manioc", panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(rf_effyg_pred, legend = T, axes = F, add = T) 
plot(cog, axes = F, add = T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)


# Resource yield gap

rf_resyg = randomForest(res_yg ~ geosurvey_ha + pop_dens + elevation + rain +
                          market + soc + cec + ph + acid_exch + sand + vegetation +
                          longitude + latitude, data = data_rf, ntree = 1500)
rf_resyg$importance
rf_resyg_pred = predict(stacked, rf_resyg, na.rm = T)
plot(cog, col='lightgrey', main = "Prediction des écarts de rendement de ressources du manioc", panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(rf_resyg_pred, legend = T, axes = F, add = T) 
plot(cog, axes = F, add = T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)



