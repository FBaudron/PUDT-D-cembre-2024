#' ---
#' title: "Yield gap analysis PUDT"
#' author: "Frédéric Baudron"
#' date: "12 Décembre 2024"
#' ---


# CLEAR ENVIRONMENT-------------------------------------------------------------

rm(list = ls())


# LOADING NECESSARY PACKAGES----------------------------------------------------

library(readxl)
library(janitor)
library(frontier)
library(geodata)
library(terra)
library(randomForest)


# SETTING UP THE DIRECTORY & LOADING THE DATA-----------------------------------

setwd("D:\\Mes Donnees\\1. Cirad\\PUDT\\Enquête\\")


plot = read_excel("Input_files//6.2. Champs.xlsx", sheet = 1)
manioc = read_excel("Input_files//6.4.1. Manioc.xlsx", sheet = 1)
typo = read_excel("Typo.xlsx", sheet = 1)
loc = read_excel("Input_files//1. Localisation.xlsx", sheet = 1)

# DATA PREPARATION--------------------------------------------------------------

assoc = plot[, c(1:2, 4:32)]

plot = plot[, c(1:3, 33:39, 47:79)]

manioc = manioc[, c(1, 66)]


# manioc$id = as.factor(manioc$id)

plot$manioc = ifelse(plot$manioc == "> 55% (culture principale)", 0.67, plot$manioc)
plot$manioc = ifelse(plot$manioc == "10-55% (culture associée)", 0.33, plot$manioc)
plot$manioc = ifelse(plot$manioc == "< 10% (culture mineure)", 0.05, plot$manioc)
plot$manioc = ifelse(plot$manioc == "absente (0%)", 0, plot$manioc)

names(plot)[4:15]

names(plot)[4:15] = c("surface", "jachere", "duree_jachère", "vegetation",
                  "duree_culture", "arbres_nonfruit", "foncier", "fumier", "engrais",
                  "pesticides", "herbicides", "sarclages")

manioc = merge(plot, manioc, by = "id", all.x = TRUE)

manioc$manioc = as.numeric(manioc$manioc)
manioc$manioc = manioc$manioc * manioc$surface

surf = aggregate(manioc ~ id, FUN = sum, na.rm = TRUE, data = manioc)

names(surf)[2] = "tot_surf_manioc"
names(manioc)[4] = "surf_manioc"

data = merge(manioc, surf, by = "id", all.x = TRUE)

data$prod_manioc = data$manioc_production * data$surf_manioc / data$tot_surf_manioc

data = data[!is.na(data$prod_manioc),]

data = subset(data, prod_manioc > 0)

data$yield_manioc = data$prod_manioc / data$surf_manioc

data = merge(data, typo, by = "id")


assoc$igname = as.numeric(assoc$igname != "absente (0%)")
assoc$autres_tubercules_patates_douce_taro = as.numeric(assoc$autres_tubercules_patates_douce_taro != "absente (0%)")
assoc$mais = as.numeric(assoc$mais != "absente (0%)")
assoc$soja = as.numeric(assoc$soja != "absente (0%)")
assoc$arachide = as.numeric(assoc$arachide != "absente (0%)")
assoc$riz = as.numeric(assoc$riz != "absente (0%)")
assoc$sorgho = as.numeric(assoc$sorgho != "absente (0%)")
assoc$haricot = as.numeric(assoc$haricot != "absente (0%)")
assoc$pois_dangole = as.numeric(assoc$pois_dangole != "absente (0%)")
assoc$lentille = as.numeric(assoc$lentille != "absente (0%)")
assoc$sesame = as.numeric(assoc$sesame != "absente (0%)")
assoc$ananas = as.numeric(assoc$ananas != "absente (0%)")
assoc$pasteque = as.numeric(assoc$pasteque != "absente (0%)")
assoc$legumes_feuilles_oseille = as.numeric(assoc$legumes_feuilles_oseille != "absente (0%)")
assoc$legumes_fruits_aubergine_tomate_courge = as.numeric(assoc$legumes_fruits_aubergine_tomate_courge != "absente (0%)")
assoc$safou = as.numeric(assoc$safou != "absente (0%)")
assoc$cacao = as.numeric(assoc$cacao != "absente (0%)")
assoc$cafe = as.numeric(assoc$cafe != "absente (0%)")
assoc$plantain = as.numeric(assoc$plantain != "absente (0%)")
assoc$banane = as.numeric(assoc$banane != "absente (0%)")
assoc$palmier = as.numeric(assoc$palmier != "absente (0%)")
assoc$manguier = as.numeric(assoc$manguier != "absente (0%)")
assoc$avocatier = as.numeric(assoc$avocatier != "absente (0%)")
assoc$agrumes = as.numeric(assoc$agrumes != "absente (0%)")
assoc$litchi = as.numeric(assoc$litchi != "absente (0%)")
assoc$ramboutan = as.numeric(assoc$ramboutan != "absente (0%)")
assoc$papaye = as.numeric(assoc$papaye != "absente (0%)")
assoc$canne_a_sucre = as.numeric(assoc$canne_a_sucre != "absente (0%)")
assoc$autres_arbres_fruitiers = as.numeric(assoc$autres_arbres_fruitiers != "absente (0%)")

assoc$tubercules = assoc$igname + assoc$autres_tubercules_patates_douce_taro
assoc$cereales = assoc$mais + assoc$sorgho + assoc$sesame
assoc$legumineuses = assoc$soja + assoc$arachide + assoc$haricot + assoc$pois_dangole + assoc$lentille
assoc$legumes = assoc$legumes_feuilles_oseille + assoc$legumes_fruits_aubergine_tomate_courge + assoc$pasteque
assoc$fruitiers = assoc$safou + assoc$cacao + assoc$cafe + assoc$manguier + assoc$avocatier +
  assoc$agrumes + assoc$litchi + assoc$ramboutan + assoc$papaye + assoc$palmier
assoc$banane_plantain = assoc$banane + assoc$plantain

assoc$tubercules = ifelse(assoc$tubercules > 0, 1, 0)
assoc$cereales = ifelse(assoc$cereales > 0, 1, 0)
assoc$legumineuses = ifelse(assoc$legumineuses > 0, 1, 0)
assoc$legumes = ifelse(assoc$legumes > 0, 1, 0)
assoc$fruitiers = ifelse(assoc$fruitiers > 0, 1, 0)
assoc$banane_plantain = ifelse(assoc$banane_plantain > 0, 1, 0)

names(assoc)

data = merge(data, assoc[, c(2, 32:37)])

names(data)

par(mar=c(5,5,5,5))

boxplot(data$yield_manioc)
data =  data[data$yield_manioc < 20000,]
boxplot(data$yield_manioc)

data$engrais = ifelse(data$engrais > 0, "Oui", "Non")
data$pesticides = ifelse(data$pesticides > 0, "Oui", "Non")

table(data$duree_jachère)

data$duree_jachère = ifelse(data$duree_jachère == "1-2 ans" | data$duree_jachère == "3-5 ans",
                            "1-5 ans", "> 5 ans")

data$duree_culture = ifelse(data$duree_culture == "< 1an" | data$duree_culture == "1 an" | data$duree_culture == "2 ans",
                            "1-2 ans", "> 2 ans")


# STOCHASTIC FRONTIER ANALYSIS--------------------------------------------------

# Data transformations

data$log_yield_manioc = log(data$yield_manioc / mean(data$yield_manioc, na.rm=TRUE))
data$log_surface = log(data$surf_manioc / mean(data$surf_manioc, na.rm=TRUE))


# Explaining (in)efficiencies


SFA = sfa(log_yield_manioc ~ as.factor(fumier) + as.factor(engrais) + as.factor(pesticides) +
            as.factor(sarclages) + as.factor(vegetation) + 
            as.factor(duree_jachère) +  as.factor(duree_culture) +
            as.factor(tubercules) + as.factor(cereales) + as.factor(legumineuses) + 
            as.factor(legumes) + as.factor(fruitiers) + as.factor(banane_plantain) + 
            as.factor(arbres_nonfruit) + as.factor(destructions_animaux) + as.factor(pertes_climat) | 
            log_surface + foncier + departement + type3 + type_farm, data = data)

summary(SFA)

SFA_df = as.data.frame(coef(summary(SFA)))

 write.xlsx(SFA_df, "Analyse de frontière stochastique - Manioc 12 Dec 24.xlsx", rowNames = T)

data$efficiency = efficiencies(SFA, asInData=TRUE)

data$techeff = data$yield_manioc / data$efficiency

mean(data$yield_manioc)
mean(na.omit(data$techeff))
mean(na.omit(data$efficiency))


quantile(data$yield_manioc, 0.9)
dataHFY = subset(data, yield_manioc > quantile(data$yield_manioc, 0.9))
HFY = mean(dataHFY$yield_manioc)
HFY

data$eff_yg = data$techeff - data$yield_manioc
mean(na.omit(data$eff_yg))

data$res_yg = ifelse(HFY - data$techeff < 0, 0, HFY - data$techeff)
mean(na.omit(data$res_yg))


plot(data$yield_manioc, data$eff_yg)
plot(data$yield_manioc, data$res_yg)


data = merge(data, loc[, c(1, 5:6)])

# SPATIAL PREDICTIONS-----------------------------------------------------------

# Load rasters

# Country shapefile

cog0 = gadm(country = 'COG', level = 0, path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\admin-regions')
cog1 = gadm(country = 'COG', level = 1, path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\admin-regions')
cog2 = gadm(country = 'COG', level = 2, path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\admin-regions')

# plot(cog0)
# plot(cog1)
# plot(cog2)

# Esquisse des paysages agricoles

esq = vect("D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\esquisse\\congo paysages ok 2 tx defrich.shp")
plot(cog0, col='lightgrey', main = 'Esquisses agricoles', panel.first = grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(esq, col = c("#6BAED6","#BDD7E7","#74C476","#BAE4B3","#238B45",
                  "#08519C", "#3182BD","#A63603", "#E6550D",
                  "#FD8D3C", "#FDBE85"),
     legend = TRUE, axes = F, add = T)
plot(cog1, axes=F, add=T)
points(15.2813, -4.2744, pch = 21, bg = 'orangered', cex=2)
points(11.8664, -4.7692, pch = 21, bg = 'orangered', cex=2)


# Elevation

# elevation = geodata::elevation_30s("COG", path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\elevation')

elevation1 = geodata::elevation_3s(lon = (11 + 18.8)/2, lat = (-5.2 + 3.9)/2, path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\elevation')
elevation1 = terra::crop(elevation1, esq)
elevation1 = terra::mask(elevation1, esq)
names(elevation1) = 'elevation'
elevation2 = geodata::elevation_3s(lon = ((11 + 18.8)/2)+2, lat = (-5.2 + 3.9)/2, path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\elevation')
elevation2 = terra::crop(elevation2, esq)
elevation2 = terra::mask(elevation2, esq)
names(elevation2) = 'elevation'
elevation3 = geodata::elevation_3s(lon = (11 + 18.8)/2, lat = ((-5.2 + 3.9)/2)+2, path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\elevation')
elevation3 = terra::crop(elevation3, esq)
elevation3 = terra::mask(elevation3, esq)
names(elevation3) = 'elevation'
elevation4 = geodata::elevation_3s(lon = ((11 + 18.8)/2)+2, lat = ((-5.2 + 3.9)/2)+2, path = 'D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\elevation')
elevation4 = terra::crop(elevation4, esq)
elevation4 = terra::mask(elevation4, esq)
names(elevation4) = 'elevation'

s = sprc(elevation1, elevation2, elevation3, elevation4)
elevation = merge(s)

# 1 degree latitude at the equator = 111320 m
# 0.0008333333 * 111320 = 92.76666

# png("Elevation.png", units="in", width=7, height=7.5, res=1000)
par(mfrow=c(1,1), mar=c(0.1,0.1,0.1,1), cex.main=1.95, cex.axis=1.6)
plot(cog0, col='lightgrey', main='Elevation (m a.s.l.)', panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(elevation, 
     legend=TRUE, axes=F, add=T)
plot(cog1, axes=F, add=T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)
# dev.off()


# Total rainfall

rain = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\chirps-rainfall\\longterm-mean-yearly-rainfall.tif')
rain = terra::crop(rain, esq)
rain = terra::mask(rain, esq)
rain = terra::resample(rain, elevation)
names(rain) = 'rain'
# png("Total rainfall.png", units="in", width=7, height=7.5, res=1000)
par(mfrow=c(1,1), mar=c(0.1,0.1,0.1,1), cex.main=1.95, cex.axis=1.6)
plot(cog0, col='lightgrey', main='Total rainfall (mm/year)', panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(rain,
     legend=TRUE, axes=F, add=T)
plot(cog1, axes=F, add=T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)
# dev.off()


# Distance à la route

route = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\road\\Distance_route_OSM.tif')
route = terra::crop(route, esq)
route = terra::mask(route, esq)
route = terra::resample(route, elevation)
names(route) = 'route'
# png("Distance to market.png", units="in", width=7, height=7.5, res=1000)
pal = colorRampPalette(c('wheat', 'orange', 'orangered', 'red'))
par(mfrow=c(1,1), mar=c(0.1,0.1,0.1,1), cex.main=1.95, cex.axis=1.6)
plot(cog0, col='lightgrey', main='Distance à la route (km)', panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(route, 
     col=pal(50), 
     legend=TRUE, axes=F, add=T)
plot(cog1, axes=F, add=T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)
# dev.off()


# Soc 

soc_5 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_soc_0-5cm_30s.tif')
soc_15 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_soc_5-15cm_30s.tif')
soc_30 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_soc_15-30cm_30s.tif')
soc = (soc_5 * 5 + soc_15 * 10 + soc_30 * 15) / (5 + 10 + 15)
soc = terra::crop(soc, esq)
soc = terra::mask(soc, esq)
soc = terra::resample(soc, elevation)
names(soc) = 'soc'
# png("Soil organic carbon.png", units="in", width=7, height=7.5, res=1000)
pal = colorRampPalette(c('wheat', 'orange', 'orangered', 'red'))
par(mfrow=c(1,1), mar=c(0.1,0.1,0.1,1), cex.main=1.95, cex.axis=1.6)
plot(cog0, col='lightgrey', main='Soil organic carbon (g/kg 0-30 cm depth)', panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(soc, 
     col=pal(50), legend=TRUE, axes=F, add=T)
plot(cog1, axes=F, add=T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)
# dev.off()


# texture

sand_5 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_sand_0-5cm_30s.tif')
sand_15 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_sand_5-15cm_30s.tif')
sand_30 = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\isda-soil\\soil_af\\af_acid-exch_15-30cm_30s.tif')
sand = (sand_5 * 5 + sand_15 * 10 + sand_30 * 15) / (5 + 10 + 15)
sand = terra::crop(sand, esq)
sand = terra::mask(sand, esq)
sand = terra::resample(sand, elevation)
names(sand) = 'sand'
# png("Sand.png", units="in", width=7, height=7.5, res=1000)
pal = colorRampPalette(c('wheat', 'orange', 'orangered', 'red'))
par(mfrow=c(1,1), mar=c(0.1,0.1,0.1,1), cex.main=1.95, cex.axis=1.6)
plot(cog0, col='lightgrey', main='Sand (%, 0-30 cm depth)', panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(sand, 
     col=pal(50), legend=TRUE, axes=F, add=T)
plot(cog1, axes=F, add=T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)
# dev.off()

# Population density

pop_dens = terra::rast('D:\\Mes Donnees\\1. Cirad\\PUDT\\Geo\\input-data\\population\\COG10adjv3.tif')
pop_dens = terra::crop(pop_dens, esq)
pop_dens = terra::mask(pop_dens, esq)
# pop_dens = pop_dens/100  # convert to person/km2
# pop_dens = terra::aggregate(pop_dens, 10)
pop_dens = terra::resample(pop_dens, elevation)
names(pop_dens) = 'pop_dens'
# png(file=paste0(output_path, "./3-population-density.png"), 
#      height = 7, width = 9, units="in", res=1000)
pal = colorRampPalette(c('wheat', 'orange', 'orangered'))
par(mfrow=c(1,1), mar=c(0.1,0.1,0.1,1), las=1)
plot(cog0, col='lightgrey', main='Densité de population (person/km2)', panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(pop_dens,  
     breaks=c(0, 0.005, 0.01, 0.02, 0.05, 0.1, 0.5, 1, Inf), col = pal(8), 
     axes=F, add=T)
plot(cog1, add=TRUE)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)
# dev.off()


lon = init(elevation, 'x')
lon = terra::crop(lon, esq)
lon = terra::mask(lon, esq)
lon = terra::resample(lon, elevation)
names(lon) = "longitude"

lat = init(elevation, 'y')
lat = terra::crop(lat, esq)
lat = terra::mask(lat, esq)
lat = terra::resample(lat, elevation)
names(lat) = "latitude"


esq_raster = rasterize(esq, elevation, field = "type", background = NA)

mosaique = esq_raster == 0 | esq_raster == 1 | esq_raster == 5 | esq_raster == 6
mosaique = subst(mosaique, c(FALSE, TRUE), c(NA, 2))

foret = esq_raster == 2 | esq_raster == 3 | esq_raster == 4
foret = subst(foret, c(FALSE, TRUE), c(NA, 3))

savane = esq_raster == 7 | esq_raster == 8 | esq_raster == 9 | esq_raster == 10
savane = subst(savane, c(FALSE, TRUE), c(NA, 1))

s <- sprc(mosaique, foret, savane)
esq_raster_3classes <- merge(s)

esq_raster_3classes = as.factor(esq_raster_3classes)


stacked = c(esq_raster, elevation, rain, route, soc, sand, lon, lat, pop_dens)


# df to spatial

data_spatial = data %>%
  sf::st_as_sf(coords = c("longitude", "latitude")) %>%
  sf::st_set_crs(4326)

# Merge dataset

data = cbind(data, terra::extract(stacked, terra::vect(data_spatial)))


names(data)

data_rf = na.omit(data[, c(47, 61:62, 66:74)])


# Yield

rf_yield = randomForest(yield_manioc ~ elevation + rain + route + soc + sand 
                        + longitude + latitude
                        + pop_dens + type, data = data_rf, ntree = 1500)
rf_yield
rf_yield$importance
rf_yield_pred = predict(stacked, rf_yield, na.rm = T)
png("Prediction des rendements du manioc.png", units="in", width = 7.5, height = 7, res = 1000)
plot(cog0, col='lightgrey', main = "Prediction des rendements du manioc", panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(rf_yield_pred, legend = T, axes = F, add = T) 
plot(cog1, axes = F, add = T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)
dev.off()

# Efficiency yield gap

rf_effyg = randomForest(eff_yg ~ elevation + rain + route + soc + sand 
                        + longitude + latitude
                        + pop_dens + type, data = data_rf, ntree = 1500)
rf_effyg
rf_effyg$importance
rf_effyg_pred = predict(stacked, rf_effyg, na.rm = T)
png("Prediction des écarts de rendement d'efficience du manioc.png", units="in", width = 7.5, height = 7, res = 1000)
plot(cog0, col='lightgrey', main = "Prediction des écarts de rendement d'efficience du manioc", panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(rf_effyg_pred, legend = T, axes = F, add = T) 
plot(cog1, axes = F, add = T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)
dev.off()

# Resource yield gap

rf_resyg = randomForest(res_yg ~ elevation + rain + route + soc + sand 
                        + longitude + latitude
                        + pop_dens + type, data = data_rf, ntree = 1500)
rf_resyg
rf_resyg$importance
rf_resyg_pred = predict(stacked, rf_resyg, na.rm = T)
png("Prediction des écarts de rendement de ressources du manioc.png", units="in", width = 7.5, height = 7, res = 1000)
plot(cog0, col='lightgrey', main = "Prediction des écarts de rendement de ressources du manioc", panel.first=grid(col="gray", lty="solid"), pax=list(sides=1:2, cex.axis=1.5))
plot(rf_resyg_pred, legend = T, axes = F, add = T) 
plot(cog1, axes = F, add = T)
points(15.2813, -4.2744, pch=21, bg='orangered', cex=2)
points(11.8664, -4.7692, pch=21, bg='orangered', cex=2)
dev.off()


