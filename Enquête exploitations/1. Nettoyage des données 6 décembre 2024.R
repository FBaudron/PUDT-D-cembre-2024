#' ---
#' title: "Nettoyage des données PUDT"
#' author: "Frédéric Baudron & François Gatignol"
#' date: "December 6th, 2024"
#' ---


# CLEAR ENVIRONMENT-------------------------------------------------------------

rm(list = ls())


# LOADING NECESSARY PACKAGES----------------------------------------------------

library(readxl)
library(janitor)
library(openxlsx)
library(dplyr)
library(tidyr)
library(rstatix)
library(ggplot2)
library(stringr)

# SETTING UP THE DIRECTORY & LOADING THE DATA-----------------------------------

setwd("D:\\Mes Donnees\\1. Cirad\\PUDT\\Enquête\\")

data = read_excel("Data\\Enquêtes_ménages_agricoles_PUDT_-_Cirad_-_all_versions_-_labels_-_2024-10-12-16-44-14.xlsx", sheet = 1)
men1 = read_excel("Data\\Enquêtes_ménages_agricoles_PUDT_-_Cirad_-_all_versions_-_labels_-_2024-10-12-16-44-14.xlsx", sheet = 2)
plot = read_excel("Data\\Enquêtes_ménages_agricoles_PUDT_-_Cirad_-_all_versions_-_labels_-_2024-10-12-16-44-14.xlsx", sheet = 3)
men2 = read_excel("Data\\Enquêtes_ménages_agricoles_PUDT_-_Cirad_-_all_versions_-_labels_-_2024-10-12-16-44-14.xlsx", sheet = 4)

data = clean_names(data)
men1 = clean_names(men1)
plot = clean_names(plot)
men2 = clean_names(men2)

men = rbind(men1, men2)

# 1. LOCALISATION---------------------------------------------------------------

loc = data[, c(732, 4:6, 8:10)]

names(loc) = c("id", "departement", "district", "village", "latitude", "longitude", "altitude")

#Nettoyage des noms des villages
# a. On passe l'ensemble des localisations sous le format "Aaaaaa"
loc$village = str_to_title(loc$village)
loc$village=as.factor(loc$village)
levels(loc$village)
# b. Nettoyage des noms df "loc"
loc = loc %>% mutate(village = recode(village,"Alembe"="Allembe", "Amboue(Complement Menage Boudji)"="Boundji",
                                      "Alembé"="Allembe", "Allémbé"="Allembe", "Amboue (Complement Menage Boudji)"="Boundji",
                                      "Amboue( Complement Ménage Boudji)"="Boundji", "Andian"="Andzian", "Andzion"="Andzian",
                                      "Ankono(Ajout Menage Mboundzi)"="Boundji", "Banda Banza"="Banda Mbanza",
                                      "Banda Mbabza"="Banda Mbanza", "Banda Mbanza"="Banda Mbanza", "Banda Mbaza"="Banda Mbanza",
                                      "Bingonga"="Binkonga", "Bingongac"="Binkonga","Bitsika"="Bitika","Bokolongo (Bobele)"="Bokolongo",
                                      "Boucy-Boucy"="Bouncy Bouncy", "Boucy Boucy"="Bouncy Bouncy", "Boudhou"="Boudouhou","Coup Raté (Impoh 2)" = "Coup Raté(Impo 2)",
                                      "Coup Raté (Impoh)"= "Coup Raté(Impo 2)", "Coup Raté (Impoh2)"= "Coup Raté(Impo 2)",
                                      "Coup Raté(Impo 2)111"= "Coup Raté(Impo 2)", "Edouala"="Sanga", "Ingilo2"="Ingolo 2",
                                      "Inglo2 (Sibiti)"="Ingolo 2", "Ingolo2 Zananga (Sibiti)"="Ingolo 2", "Ingolo2 Zananga (Sibiti)"="Ingolo 2",
                                      "Ingolo2"= "Ingolo 2", "Issengué"="Isséngué","Ito"="Itoh", "Kah-Ognali"= "Kah-Ongali",
                                      "Kah-Ongale"= "Kah-Ongali", "Kah-Ognogni"= "Kah-Ongali","Kebaraq"="Kebara",
                                      "Kekelé"="Kekele","Kékélé"="Kekele", "Kigandou Kinsassa"="Kingandou Kinsassa",
                                      "Kimbeti"="Kimbedi",  "Kimpéssi" = "Kimpessi","Kindimga"="Kindinga", "Kingandou"="Kingandou Kinsassa",
                                      "Kitsindi" ="Kisindi", "Komi 3"="Komi", "Koussou Kabamla"="Koussou Kamba", "Laka Centre"="Laka",
                                      "Lengui-Lengui"="Léngui-Léngui", "Léngui Léngui"="Léngui-Léngui", "Loubikoutou"="Loubitoukou",
                                      "Loubitoukou (Mantsouini)"="Loubitoukou","Loubitoukouk"="Loubitoukou", "Loubitoukou Matouini"="Loubitoukou",
                                      "Loubitoukou Mantouini"="Loubitoukou","Loubitoukou Matouini"="Loubitoukou", "Loukoung"="Loukounga", "Loukounga - Kimpolo"="Loukounga",
                                      "Lemba Ngoyo"="Lemba", "Loukoung"="Loukounga", "Loukounga - Kimpolo"="Loukounga",
                                      "Malolo1"="Malolo 1", "Manga Kombe"="Manga Kombé", "Massengo- Ngoma"="Massengo Ngoma", "Massengo Goma"="Massengo Ngoma",
                                      "Massengo Ngoma Mouyondzi"="Massengo Ngoma","Massengo Ngoma Moyondzi"="Massengo Ngoma", "Mba Ntsio"="Mbantsio",
                                      "Mban Antsio" = "Mbantsio","Mban Ntsion"="Mbantsio", "Ntombo Manianga"="Ntombo Manianga 2",
                                      "Mban Tsion"="Mbantsio","Midiawo"="Mediawo", "Mikisou"="Mikizou", "Mingouengouele"="Mingouengouelé",
                                      "Mitiko"="Mitoko", "Miubiri"="Moubiri", "Mitiko"="Mitoko", "Miubiri"="Moubiri", "Ntombo Manianga" = "Ntombo Manianga 2",
                                      "Mongoumba 2"="Mongoumba 2", "Mouindi\n"="Mouindi", "Moukéké"="Moukeke", "Moukondo Yama"="Moukoundo Yama",
                                      "Moukoundo"="Moukoundo Yama","Moukounko Yama"="Moukoundo Yama", "Moungouma 1"="Moungoumba 1", 
                                      "Moungouma 2"="Moungoumba 2", "Mousséhou"="Moussehou","Moutele"="Moutélé", "Moutende"="Moutendé",
                                      "Mpangala\n"="Mpangala", "Mpouadzion"="Mpouandzio","Mpouandzion"="Mpouandzio", "Mpouanzio"="Mpouandzio",
                                      "Nganda 2."="Nganda 2","Ngantsaki"="Ngantseke","Ngatsake"="Ngantseke","Ngatsankie"="Ngantseke","Ngombe - Mpati"="Ngombe-Mpati", "Ngombe Mpati"="Ngombe-Mpati", "Ngombe"="Ngombe-Mpati",
                                      "Ntombo Ii"="Ntombo Manianga 2", "Mbamba Loutembo"="Mbamba","Ntandou Milomba" = "Tandou Milomba",
                                      "Ntombo Manianga1"="Ntombo Manianga 2","Ntombo Manianga2"="Ntombo Manianga 2", "Lucking"="Oudjoungo", "Kinbeti"="Kimbedi",
                                      "Ossangou"="Ossangou 1", "Ossangou 3"="Ossangou 3", "Ossombo 3"="Ossangou 3", "Ossele"="Ossélé", "Ossongo 3"="Ossangou 3", "Ossélé Poste"="Ossélé",
                                      "Oudjongo"="Oudjoungo", "Oyoué 1"="Oyoué", "Pete - Simbola"="Pete", "Petè - Mopepe"="Pete", "Qtier Ebongo"="Lekana(Quartier Ebongo 2)",
                                      "Qtier. Ebongo"="Lekana(Quartier Ebongo 2)", "Tandoumilomba"="Tandou Milomba", "Tanga (Ngotimanga)"="Tanga", "Nkomi"="Komi", "Kiniambi Loeme"="Tchiniambi Loémé",
                                      "Tchiniabi Centre"="Tchiniambi Loémé", "Tchiniambi Loémé Centre"="Tchiniambi Loémé", "Tchiniambi Loéme ()"="Tchiniambi Loémé", "Tchiniambi Centre"="Tchiniambi Loémé",
                                      "Tchiniambi Loémé Village Centre"="Tchiniambi Loémé","Tsiessi Gare"="Tsessi Gare", "Ossengou 3"="Ossangou 3", "Tchiniambi Loeme"="Tchiniambi Loémé",
                                      "Ossembo 3"="Ossangou 3", "Kissindi"="Kisindi", "Assangou"="Ossangou 1", "Oti"="Itoh", "Ouanze"="Ouanzi", "Ntombo"="Ntombo Manianga 2", "Olangue"="Miaba",
                                      "Moukamba"="Moulamba", "Moutamba"="Moulamba", "Miusséhou"="Moussehou", "Mongoumba"="Moungoumba 1",
                                      "Mougoumba 2"="Moungoumba 2","Mongoumba"="Moungoumba 1", "Ntsampoko"="Tsampoko", "Louomo Kiyala"="Kiyala Louomo",
                                      "Okah-Ognali"="Kah-Ongali", "Mbama"="Mbamou", "Coup Raté"="Coup Raté(Impo 2)","Ossombo 3"="Ossangou 3", 
                                      "Kieni"="Nkieni","Kenilworth's"="Nkieni", "Kounga Kimambou"="Nkounga", "Kounga"="Nkounga", "Ntombo Manianga"="Ntombo Manianga 2",
                                      "Ndjouono"="Njouono", "Moungoumba"="Moungoumba 2", "Moungouma"="Moungoumba 1", "Kipanda 2"="Kimpanda", "Ngatsenkie"="Ngantseke",
                                      "Mboundzi"="Boundji", "Boudji"="Boundji", "Kikanga"="Kinkanga", "Loukounga- Kimpolo"="Loukounga", "Koussou Kambala"="Koussou Kamba" ,
                                      "Bembo Boté"="Mbembo Mboté", "Kempéssi"= "Kimpessi", "Kimpanda 2"="Kimpanda", "Bobele"="Bokolongo", "Bougounga 2"="Moungoumba 2", "Moungouma"="Moungoumba 1", "Impeni"="Impani",
                                      "Etouala"="Sanga", "Kissindi"="Kisindi"))


loc$village[loc$village == "Oka" & loc$district == "Ngo" ] = "Okah"  
loc$village[loc$village == "Ngouanga" & loc$district == "Banda" ] = "Ngouaga (Ibonga Mouyima)"   
loc$village[loc$village == "Ngouaga" & loc$district == "Banda" ] = "Ngouaga (Ibonga Mouyima)"   
loc$village[loc$village == "Ngouaga (Ibonga Mouyima)" & loc$district == "Banda" ] = "Ngouaga (Ibonga Mouyima)"   
loc$village[loc$village == "Nguanga" & loc$district == "Banda" ] = "Ngouaga (Ibonga Mouyima)"   
loc$village[loc$village == "Ngounga" & loc$district == "Banda" ] = "Ngouaga (Ibonga Mouyima)"   
loc$village[loc$village == "Mbamba Loutengo" & loc$district == "Madingo-Kayes" ] = "Loutembo"   
loc$village[loc$id == 220  ] = "Loutembo"   
loc$village[loc$id == 221  ] = "Loutembo" 
loc$district[loc$id == 381] = "Mvouti" 
loc$district[loc$id == 1080 ] = "Kimongo"
loc$district[loc$id ==  964 ] = "Kimongo"
loc$district[loc$id ==  966 ] = "Kimongo" 
loc$district[loc$id ==  227 ] = "Boko-Songho"
loc$district[loc$id ==  222 ] = "Boko-Songho"
loc$district[loc$id ==  1240 ] = "Loumo"

# write.xlsx(loc, file = "Input_files\\1. Localisation.xlsx")


# 2. ENQUETE--------------------------------------------------------------------

enq = data[, c(732, 13:15, 18:32, 34, 33, 35, 36)]

names(enq) = c("id", "nom", "prenom", "foyer_femme", "lingala", "kikongo", "lari",
               "kituba", "teke", "mbochi", "vili", "kuilu", "luango", "lubomo",
               "bomitaba", "ndjem", "yombe", "francais", "anglais", "baaka", "autre",
               "langue_precisez", "taille_famille")

enq$foyer_femme = as.numeric(enq$foyer_femme == "Femme")

enq$langue_precisez = as.factor(enq$langue_precisez)

summary(enq$langue_precisez)

# Debut du nettoyage des données pour les langues quand il s'agissait de remplir une langue "Autre" à la main.

enq = enq %>% mutate(langue_precisez = recode(langue_precisez,"Kouni"="Kuni", "Nsundi"="Soundi","SOUNDI"="Soundi",
                                              "KAMBA"="Kamba", "MBÉTI"="Mbéti", "KOUYOU"="Kouyou",
                                              "BEMBÉ"="Bembé",  "Mbembé"="Bembé", "LALI"="Lali",
                                              "Nkongo"="Kongo", "Koyo"="Kouyou","Loumbou"="Lumbu",
                                              "Zembi"="Nzembi", "LIKUBA"="Likuba","KOUNI"="Kouni", 
                                              "Couhni"="Kouni", "BaKouele"="Bakouele", "Bakouelé"="Bakouele",
                                              "Mbembé"="Bembé", "Bembe"="Bembé","Bakouni"="Kuni", "Koyou"="Kouyou",
                                              "Nsoundi"="Soundi", "Nzembi"="Nzebi","Lala"="Lali","kota"="Kota",
                                              "Lali, Téké"="Lali", "Kamba et Mu-kongo"="Kamba", "MBOKO et MBÉTI"="Mbéti",
                                              "Kamba et Mu-kongo"="Kamba", "Bébé, kikéngué"="Bébé", "Ngobè"="Ngombe",
                                              "DONDO"="Dondo", "BEMBE"="Bembé","Kibémbé"="Bembé","MBOKO"="Mboko",
                                              "Likouala et Kouyou"="Kouyou", "Likouala et Mbochi"="Mbochi", "Bakouele"="Kouélé",
                                              "Kouele"="Kouélé","NGATSÉ"="Ngatsé", "Lounmbou"="Loumbou","Lombo"="Loumbou",
                                              "Loubou"="Loumbou", "NGUELE"="Nguele","Mbembe"="Bembé","Loumbo"="Loumbou",
                                              "Punou"="Pounou", "Mbamba, Lali, Yaka, Mbembe"="Mbamba","Mbamba, bandassa"="Mbamba",
                                              "Kilali"="Lali", "MBAMBA"="Mbamba", "Mbembe, Yaka"= "Mbembé", "Mbembe, yaka, mbamba"="Mbembé",
                                              "Mbomitaba"="Bomitaba", "Bomi taba"="Bomitaba", "Mbembé"="Bembé", "Bomitaka"="Bomitaba",
                                              "Ibongo"="Bongo", "Loumbou de Dibeni"="Lumbu"
))


# write.xlsx(enq, file = "Input_files\\2. Enquêté.xlsx")

# 3. MENAGE---------------------------------------------------------------------

# 3.1. Membres du ménage

men = men[, c(19, 17, 2:8, 10:12, 14:16)]

names(men) = c("id", "mb_id", "genre", "age", "education", "activite_1", "activite-1_precisez",
               "periodicite_1", "revenus_1", "activite_2", "periodicite_2", "revenus_2",
               "activite_3", "periodicite_3", "revenus_3")

men$revenus_1[is.na(men$revenus_1)] = 0
men$revenus_2[is.na(men$revenus_2)] = 0
men$revenus_3[is.na(men$revenus_3)] = 0

men$revenus_totaux = men$revenus_1 +
  men$revenus_2 +
  men$revenus_3

# write.xlsx(men[, c(1:6, 10, 13)], file = "Input_files\\3.1. Membres du ménage.xlsx")


# 3.2. Chef de famille

chf = men %>% 
  group_by(id) %>% 
  filter(mb_id == min(mb_id)) %>% 
  ungroup()

chf = chf[, c(1, 3:5)]

names(chf) = c("id", "genre_chef_fam", "age_chef_fam", "education_chef_fam")

# write.xlsx(chf, file = "Input_files\\3.2. Chef de famille.xlsx")


# 4. HISTOIRE-------------------------------------------------------------------

his = data[, c(732, 37:38, 40:48, 50:56, 58, 57, 59)]

names(his) = c("id", "indigene", "toujours_village", "insecurite", "etudes", "travail",
               "raisons_familiales", "raisons_economiques", "quitte_village_autre",
               "quitte_village_precisez", "departement_origine", "duree_village",
               "terre_natale", "terre_fertile", "pluies_mois_incertaines", "zone_moins_enclavee",
               "acces_terre_facile", "emploi_terres", "conflit_village_natal", "proche_conjoint",
               "installation_autre", "installation_precisez")

his$indigene = as.numeric(his$indigene == "Oui")

# write.xlsx(his, file = "Input_files\\4. Histoire.xlsx")


# 5. SECURITE ALIMENTAIRE-------------------------------------------------------

ali = data[, c(732, 60:62, 64:71)]

names(ali) = c("id", "nb_repas", "securite_alim", "frequence_insecurite_alim",
               "insec_argent", "insec_production", "insec_acces_marche", "insec_dispo_marche",
               "insec_proche", "insec_saison", "insec_religion", "insec_autre")

ali$securite_alim = as.numeric(ali$securite_alim == "Non")

# write.xlsx(ali, file = "Input_files\\5. Sécurité alimentaire.xlsx")


# 6. AGRICULTURE----------------------------------------------------------------

# 6.1. Agriculture générale

agr = data[, c(732, 73:78, 80:94, 97:105, 682)]

agr$autres_arbres_fruitiers_papaye_682 = agr$autres_arbres_fruitiers_papaye_682[is.na(agr$autres_arbres_fruitiers_papaye_682)] = 0

agr$autres_arbres_fruitiers_papaye_91 = agr$autres_arbres_fruitiers_papaye_91 + agr$autres_arbres_fruitiers_papaye_682

agr = agr[, -c(32)]

names(agr) = c("id", "nb_champs", "nb_systemes", "jardin", "jardin_surf", "verger",
               "verger_surf", "safoutier", "cacao", "cafe", "bananier", "plantain",
               "palmier", "manguier", "avocatier", "ananas", "agrumes", "litchi",
               "autres_arbres", "autres_terres", "jachere", "surface_louee",
               "manioc", "mais", "soja", "arachide", "safou", "cacao", "cafe",
               "plantain", "palmier")

agr$jardin = as.numeric(agr$jardin == "Oui")
agr$verger = as.numeric(agr$verger == "Oui")
agr$autres_terres = as.numeric(agr$autres_terres == "Oui")

agr$jardin_surf[is.na(agr$jardin_surf)] = 0
agr$verger_surf[is.na(agr$verger_surf)] = 0
agr$ananas[is.na(agr$ananas)] = 0
agr$jachere[is.na(agr$jachere)] = 0
agr$surface_louee[is.na(agr$surface_louee)] = 0

agr$jachere[agr$id == 644] = 50
agr$jachere[agr$id == 645] = 50
agr$jachere[agr$id == 349] = 30
agr$jachere[agr$id == 770] = 30
agr$jachere[agr$id == 348] = 10
agr$jachere[agr$id == 1321] = 10
agr$jachere[agr$id == 870] = 8

# Modification des outliers suite à des problèmes dans les ordres de grandeur
# Pour la variable "jachere" : Terres que l'enquêté à en propriété mais qui sont en jachère

agr$jachere[agr$id == 644] = 50
agr$jachere[agr$id == 645] = 50
agr$jachere[agr$id == 349] = 30
agr$jachere[agr$id == 770] = 30
agr$jachere[agr$id == 348] = 10
agr$jachere[agr$id == 1321] = 10
agr$jachere[agr$id == 870] = 8


# Pour la variable "surface_louee" : Terres que l'enquêté à en propriété et qui sont louées

agr$surface_louee[agr$id == 644] = 10
agr$surface_louee[agr$id == 645] = 10
agr$surface_louee[agr$id == 349] = 7 
agr$surface_louee[agr$id == 770] = 3 
agr$surface_louee[agr$id == 870] = 1 


# Pour la variable "jardin_surf" : On vérifie toutes les valeurs >1ha et on corrige les ordres de grandeur

agr$jardin_surf[agr$id == 97] = 0.04
agr$jardin_surf[agr$id == 185] = 0.04
agr$jardin_surf[agr$id == 577] = 0.03
agr$jardin_surf[agr$id == 135] = 0.01
agr$jardin_surf[agr$id == 169] = 0.05
agr$jardin_surf[agr$id == 1087] = 0.04
agr$jardin_surf[agr$id == 138] = 0.03
agr$jardin_surf[agr$id == 1290] = 0.03
agr$jardin_surf[agr$id == 1086] = 0.02
agr$jardin_surf[agr$id == 1214] = 0.02
agr$jardin_surf[agr$id == 1395] = 0.02
agr$jardin_surf[agr$id == 318] = 0.05 
agr$jardin_surf[agr$id == 12] =  0.05
agr$jardin_surf[agr$id == 417] = 0.02
agr$jardin_surf[agr$id == 45] = 0.015
agr$jardin_surf[agr$id == 260] = 0.015
agr$jardin_surf[agr$id == 263] = 0.015
agr$jardin_surf[agr$id == 611] = 0.015 
agr$jardin_surf[agr$id == 816] = 0.015  
agr$jardin_surf[agr$id == 150] = 0.013   

  
# write.xlsx(agr[, c(1:7, 20:22)], file = "Input_files\\6.1. Agriculture générale.xlsx")


# 6.2. Champs

plot = plot[, c(82, 80, 2:51, 53:69, 71:79)]

names(plot)[1] = "id"
names(plot)[2] = "ch_id"

# Correction manuelle des outliers sur les surfaces cultivées. df "plot"
# Les valeurs aberrantes sont modifées à la main. On passe au peigne fin toutes les surfaces > 3.5ha

plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1490] = 15
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 2431] = 3.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 594] = 1
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 595] = 1
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 598] = 0.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 599] = 0.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 2205] = 0.1
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 145] = 0.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 142] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 143] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1873] = 0.25
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 2328] = 0.25
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 27] = 0.23
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1496 ] = 0.19
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 553] = 0.15
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1333] = 1.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1490] = 1.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 2568] = 1.5 
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 26] =  0.13
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1239] = 1
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 2567] = 1
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1089] = 0.9
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 65] = 0.8
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 251] = 0.8
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1491] = 0.8
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1878] = 0.8
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1281] = 0.7
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 329] = 0.6
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 554] = 0.6
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 564] = 0.6
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 2262] = 6 
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 2549] = 0.6
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1877] = 0.55
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 64] = 5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 252] = 0.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 307] = 0.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 485] = 5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 552] = 5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 645] = 0.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1103] = 0.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1883] = 0.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 2019] = 0.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 2662] = 5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 439] = 4.5
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 18] = 4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 40] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 47] =  4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 476] = 4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 988] =  4 
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1052] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1053] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1166] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1174] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1238] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1492] = 4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1493] = 4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1497] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1627] = 4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1629] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1646] = 4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1786] = 0.4
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 1824] = 0.4 
plot$quelle_est_la_surface_associee_ha[plot$ch_id == 2173] =  4 

plot$quelle_est_la_surface_associe_ha[plot$ch_id == 263] = 0.25 
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 2501] = 0.3
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 225] = 0.4
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 226] = 0.4
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 261] = 0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1464] = 0.9
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1465] = 0.9
plot$quelle_est_la_surface_associe_ha[plot$ch_id %in% 266:273] = 0.1
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 273] = 0.1
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 2188] = 0.2
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1677] = 0.25
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1678] = 0.25
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1679] = 0.25
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 264] = 0.3
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1675] = 0.3
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1676] = 0.3
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1680] = 0.3
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1816] = 0.3
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1817] = 0.3
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 2500] = 0.3
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1109] = 0.4
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1219] = 0.4 
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 2140] = 0.4
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 302] = 0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1674] = 0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1681] = 0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == plot$ch_id %in% 2334:2344] = 0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == plot$ch_id %in% 2346:2349] = 0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == plot$ch_id %in% 2450:2451] = 0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == plot$ch_id %in% 2518:2519] = 0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 2523] = 0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 2528] = 0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == plot$ch_id %in% 2640:2644] =0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == plot$ch_id %in% 2650:2651] =0.5
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1351] = 0.6
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1461] = 0.6
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1462] = 0.6
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 131] = 0.625
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1538] = 0.625
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1691] = 0.625
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1766] = 0.625 
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1850] = 0.625
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1673] = 0.7
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1690] = 0.8
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1752] = 0.8
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 1753] = 0.8
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 34] = 0.8
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 35] = 0.8
plot$quelle_est_la_surface_associe_ha[plot$ch_id == 2500] = 0.3


names(plot)[c(1,2,33:46)] = c("id","ch_id", "plot_surface", "previous_fallow", "fallow_duration", "previous_vegetation", "cultivation_time","trees_on_plot",
                               "statut_champ", "precisez", "prix_loc", "prix_loc_nature", "mode_acquisition","precisez_1","date_achat", "prix_achat_hectare")

names(plot)[c(47:78)] = c("fumier_lisier", "qte_engrais", "nb_pesticide", "nb_herbicide", "nb_sarclages",
                       "destructions_animaux", "bovins", "chevres", "moutons", "elephants", "buffles",
                       "hippopotames", "cochons_sauvages", "antilopes", "grands_singes", "petits_singes",
                       "rongeurs", "oiseaux", "mille_pattes", "criquets", "chenilles", "autres_insectes",
                       "pertes_climat", "secheresse", "chaleur", "inondation", "incendie", "precipitation",
                       "vent", "glissement", "autre", "voleurs")

plot$previous_fallow = as.numeric(plot$previous_fallow == "Oui")

levels(as.factor(plot$statut_champ))

# Data cleaning lorsque les enqueteurs ont coché "Autre" pour la variable "statut champ" en lien avec la propriété

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Location" ] = "Fermage"
plot$precisez[plot$statut_champ == "Fermage" & plot$precisez == "Location"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Achat" ] = "Propriété (suite à achat)"
plot$precisez[plot$statut_champ == "Propriété (suite à achat)" & plot$precisez == "Achat"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Achat pour le maraichage" ] = "Propriété (suite à achat)"
plot$precisez[plot$statut_champ == "Propriété (suite à achat)" & plot$precisez == "Achat pour le maraichage"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Heritage" ] = "Propriété (sans titre)"
plot$precisez[plot$statut_champ == "Propriété (sans titre)" & plot$precisez == "Heritage"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Terre gratuit" ] = "Prêt gratuit"
plot$precisez[plot$statut_champ == "Prêt gratuit" & plot$precisez == "Terre gratuit"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Terre gratuit" ] = "Prêt gratuit"
plot$precisez[plot$statut_champ == "Prêt gratuit" & plot$precisez == "Terre gratuit"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Terre gratuite" ] = "Prêt gratuit"
plot$precisez[plot$statut_champ == "Prêt gratuit" & plot$precisez == "Terre gratuite"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Location aupres des terriens" ] = "Fermage"
plot$precisez[plot$statut_champ == "Fermage" & plot$precisez == "Location aupres des terriens"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Acquisition volontaire" ] = "Prêt gratuit"
plot$precisez[plot$statut_champ == "Prêt gratuit" & plot$precisez == "Location aupres des terriens"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Don" ] = "Propriété (sans titre)"
plot$precisez[plot$statut_champ == "Propriété (sans titre)" & plot$precisez == "Don"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Mariage" ] = "Propriété (sans titre)"
plot$precisez[plot$statut_champ == "Propriété (sans titre)" & plot$precisez == "Mariage"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Terre gratuite de l'etat" ] = "Bail de l'état"
plot$precisez[plot$statut_champ == "Bail de l'état" & plot$precisez == "Terre gratuite de l'etat"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Terre de l'etat, gratuit" ] = "Bail de l'état"
plot$precisez[plot$statut_champ == "Bail de l'état" & plot$precisez == "Terre de l'etat, gratuit"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Terre de l'etat, gratuit" ] = "Bail de l'état"
plot$precisez[plot$statut_champ == "Bail de l'état" & plot$precisez == "Terre de l'etat, gratuit"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Acquisition gratuit" ] = "Prêt gratuit"
plot$precisez[plot$statut_champ == "Prêt gratuit" & plot$precisez == "Acquisition gratuit"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Acquisition gratuit" ] = "Prêt gratuit"
plot$precisez[plot$statut_champ == "Prêt gratuit" & plot$precisez == "Acquisition gratuit"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Locations" ] = "Fermage"
plot$precisez[plot$statut_champ == "Fermage" & plot$precisez == "Locations"] = NA

plot$prix_loc[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Location avec 25000" ] = "25000"
plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Location avec 25000" ] = "Fermage"
plot$precisez[plot$statut_champ == "Fermage" & plot$precisez == "Location avec 25000"] = NA

plot$prix_loc[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Location avec 7500" ] = "75000"
plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Location avec 7500" ] = "Fermage"
plot$precisez[plot$statut_champ == "Fermage" & plot$precisez == "Location avec 7500"] = NA

plot$prix_loc[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Location 20000 par champ" ] = "20000"
plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Location 20000 par champ" ] = "Fermage"
plot$precisez[plot$statut_champ == "Fermage" & plot$precisez == "Location 20000 par champ"] = NA

plot$prix_loc[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Location 20000 FCFA un champ" ] = "20000"
plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Location 20000 FCFA un champ" ] = "Fermage"
plot$precisez[plot$statut_champ == "Fermage" & plot$precisez == "Location 20000 FCFA un champ"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Achat aupres des terriens" ] = "Propriété (suite à achat)"
plot$precisez[plot$statut_champ == "Propriété (suite à achat)" & plot$precisez == "Achat aupres des terriens"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Mariage, sa femme est l'une des heritiers des terres exploitées." ] = "Propriété (sans titre)"
plot$precisez[plot$statut_champ == "Propriété (sans titre)" & plot$precisez == "Mariage, sa femme est l'une des heritiers des terres exploitées."] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Par lien de mariage avec sa femme" ] = "Propriété (sans titre)"
plot$precisez[plot$statut_champ == "Propriété (sans titre)" & plot$precisez == "Par lien de mariage avec sa femme"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "" ] = "Prêt gratuit"
plot$precisez[plot$statut_champ == "Prêt gratuit" & plot$precisez == ""] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Pas de statut" ] = "Prêt gratuit"
plot$precisez[plot$statut_champ == "Prêt gratuit" & plot$precisez == "Pas de statut"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "Pas de statut, on exploite juste LA terre comme ça" ] = "Prêt gratuit"
plot$precisez[plot$statut_champ == "Prêt gratuit" & plot$precisez == "Pas de statut, on exploite juste LA terre comme ça"] = NA

plot$statut_champ[plot$statut_champ == "Autre (précisez)" & plot$precisez == "On loue aussi les terres" ] = "Fermage"
plot$precisez[plot$statut_champ == "Fermage" & plot$precisez == "On loue aussi les terres"] = NA 


plot$statut_champ = ifelse(plot$statut_champ == "Propriété (sans titre)" | plot$statut_champ == "Propriété (suite à achat)" | plot$statut_champ == "Propriété (titre foncier)",
                           "Propriété", plot$statut_champ)

plot$statut_champ = ifelse(plot$statut_champ == "Fermage", "Location", plot$statut_champ) 

plot$statut_champ = ifelse(plot$statut_champ == "Autre (précisez)" | plot$statut_champ == "Bail de l'état" | plot$statut_champ == "Gage" |
                             plot$statut_champ == "Métayage" | plot$statut_champ == "Prêt gratuit",
                           "Autre", plot$statut_champ)

# write.xlsx(plot, file = "Input_files\\6.2. Champs.xlsx")


 
man_mai_ara_saf_pla = plot[, c(1, 3, 6, 8, 19, 22, 33)]

man_mai_ara_saf_pla$manioc = ifelse(man_mai_ara_saf_pla$manioc == "> 55% (culture principale)", 1, man_mai_ara_saf_pla$manioc)
man_mai_ara_saf_pla$manioc = ifelse(man_mai_ara_saf_pla$manioc == "10-55% (culture associée)", 0.5, man_mai_ara_saf_pla$manioc)
man_mai_ara_saf_pla$manioc = ifelse(man_mai_ara_saf_pla$manioc == "< 10% (culture mineure)", 0.1, man_mai_ara_saf_pla$manioc)
man_mai_ara_saf_pla$manioc = ifelse(man_mai_ara_saf_pla$manioc == "absente (0%)", 0, man_mai_ara_saf_pla$manioc)

man_mai_ara_saf_pla$mais = ifelse(man_mai_ara_saf_pla$mais == "> 55% (culture principale)", 1, man_mai_ara_saf_pla$mais)
man_mai_ara_saf_pla$mais = ifelse(man_mai_ara_saf_pla$mais == "10-55% (culture associée)", 0.5, man_mai_ara_saf_pla$mais)
man_mai_ara_saf_pla$mais = ifelse(man_mai_ara_saf_pla$mais == "< 10% (culture mineure)", 0.1, man_mai_ara_saf_pla$mais)
man_mai_ara_saf_pla$mais = ifelse(man_mai_ara_saf_pla$mais == "absente (0%)", 0, man_mai_ara_saf_pla$mais)

man_mai_ara_saf_pla$arachide = ifelse(man_mai_ara_saf_pla$arachide == "> 55% (culture principale)", 1, man_mai_ara_saf_pla$arachide)
man_mai_ara_saf_pla$arachide = ifelse(man_mai_ara_saf_pla$arachide == "10-55% (culture associée)", 0.5, man_mai_ara_saf_pla$arachide)
man_mai_ara_saf_pla$arachide = ifelse(man_mai_ara_saf_pla$arachide == "< 10% (culture mineure)", 0.1, man_mai_ara_saf_pla$arachide)
man_mai_ara_saf_pla$arachide = ifelse(man_mai_ara_saf_pla$arachide == "absente (0%)", 0, man_mai_ara_saf_pla$arachide)

man_mai_ara_saf_pla$safou = ifelse(man_mai_ara_saf_pla$safou == "> 55% (culture principale)", 1, man_mai_ara_saf_pla$safou)
man_mai_ara_saf_pla$safou = ifelse(man_mai_ara_saf_pla$safou == "10-55% (culture associée)", 0.5, man_mai_ara_saf_pla$safou)
man_mai_ara_saf_pla$safou = ifelse(man_mai_ara_saf_pla$safou == "< 10% (culture mineure)", 0.1, man_mai_ara_saf_pla$safou)
man_mai_ara_saf_pla$safou = ifelse(man_mai_ara_saf_pla$safou == "absente (0%)", 0, man_mai_ara_saf_pla$safou)

man_mai_ara_saf_pla$plantain = ifelse(man_mai_ara_saf_pla$plantain == "> 55% (culture principale)", 1, man_mai_ara_saf_pla$plantain)
man_mai_ara_saf_pla$plantain = ifelse(man_mai_ara_saf_pla$plantain == "10-55% (culture associée)", 0.5, man_mai_ara_saf_pla$plantain)
man_mai_ara_saf_pla$plantain = ifelse(man_mai_ara_saf_pla$plantain == "< 10% (culture mineure)", 0.1, man_mai_ara_saf_pla$plantain)
man_mai_ara_saf_pla$plantain = ifelse(man_mai_ara_saf_pla$plantain == "absente (0%)", 0, man_mai_ara_saf_pla$plantain)

man_mai_ara_saf_pla$manioc = as.numeric(man_mai_ara_saf_pla$manioc)
man_mai_ara_saf_pla$mais = as.numeric(man_mai_ara_saf_pla$mais)
man_mai_ara_saf_pla$arachide = as.numeric(man_mai_ara_saf_pla$arachide)
man_mai_ara_saf_pla$safou = as.numeric(man_mai_ara_saf_pla$safou)
man_mai_ara_saf_pla$plantain = as.numeric(man_mai_ara_saf_pla$plantain)

man_mai_ara_saf_pla$manioc = man_mai_ara_saf_pla$manioc * man_mai_ara_saf_pla$plot_surface
man_mai_ara_saf_pla$mais = man_mai_ara_saf_pla$mais * man_mai_ara_saf_pla$plot_surface
man_mai_ara_saf_pla$arachide = man_mai_ara_saf_pla$arachide * man_mai_ara_saf_pla$plot_surface
man_mai_ara_saf_pla$safou = man_mai_ara_saf_pla$safou * man_mai_ara_saf_pla$plot_surface
man_mai_ara_saf_pla$plantain = man_mai_ara_saf_pla$plantain * man_mai_ara_saf_pla$plot_surface

man_mai_ara_saf_pla = aggregate(. ~ id, FUN = sum, na.rm = TRUE, data = man_mai_ara_saf_pla)

names(man_mai_ara_saf_pla) = c("id", "surf_manioc", "surf_mais", "surf_arachide", "surf_safou", "surf_plantain", "surf_cultivee")


# 6.3. Diversité de cultures

plot$manioc = as.numeric(plot$manioc != "absente (0%)")
plot$igname = as.numeric(plot$igname != "absente (0%)")
plot$autres_tubercules_patates_douce_taro = as.numeric(plot$autres_tubercules_patates_douce_taro != "absente (0%)")
plot$mais = as.numeric(plot$mais != "absente (0%)")
plot$soja = as.numeric(plot$soja != "absente (0%)")
plot$arachide = as.numeric(plot$arachide != "absente (0%)")
plot$riz = as.numeric(plot$riz != "absente (0%)")
plot$sorgho = as.numeric(plot$sorgho != "absente (0%)")
plot$haricot = as.numeric(plot$haricot != "absente (0%)")
plot$pois_dangole = as.numeric(plot$pois_dangole != "absente (0%)")
plot$lentille = as.numeric(plot$lentille != "absente (0%)")
plot$sesame = as.numeric(plot$sesame != "absente (0%)")
plot$ananas = as.numeric(plot$ananas != "absente (0%)")
plot$pasteque = as.numeric(plot$pasteque != "absente (0%)")
plot$legumes_feuilles_oseille = as.numeric(plot$legumes_feuilles_oseille != "absente (0%)")
plot$legumes_fruits_aubergine_tomate_courge = as.numeric(plot$legumes_fruits_aubergine_tomate_courge != "absente (0%)")
plot$safou = as.numeric(plot$safou != "absente (0%)")
plot$cacao = as.numeric(plot$cacao != "absente (0%)")
plot$cafe = as.numeric(plot$cafe != "absente (0%)")
plot$plantain = as.numeric(plot$plantain != "absente (0%)")
plot$banane = as.numeric(plot$banane != "absente (0%)")
plot$palmier = as.numeric(plot$palmier != "absente (0%)")
plot$manguier = as.numeric(plot$manguier != "absente (0%)")
plot$avocatier = as.numeric(plot$avocatier != "absente (0%)")
plot$agrumes = as.numeric(plot$agrumes != "absente (0%)")
plot$litchi = as.numeric(plot$litchi != "absente (0%)")
plot$ramboutan = as.numeric(plot$ramboutan != "absente (0%)")
plot$papaye = as.numeric(plot$papaye != "absente (0%)")
plot$canne_a_sucre = as.numeric(plot$canne_a_sucre != "absente (0%)")
plot$autres_arbres_fruitiers = as.numeric(plot$autres_arbres_fruitiers != "absente (0%)")
plot$trees_on_plot = as.numeric(plot$trees_on_plot == "Oui")

plot$canne_a_sucre[is.na(plot$canne_a_sucre)] = 0

# Nettoyage "prix_loc" quand le prix de la location est exorbitant

plot$prix_loc[plot$ch_id == 1873  ] = 130000   
plot$prix_loc[plot$ch_id == 120  ] = 15000  


# Nettoyage  "date_achat" quand la date est mauvaise

plot$date_achat[plot$date_achat ==  3 ] =  NA
plot$date_achat[plot$date_achat ==  14 ] =  2014
plot$date_achat[plot$date_achat ==  20 ] =  2020
plot$date_achat[plot$date_achat ==  30 ] =  NA


# Nettoyage "prix-achat_hectare" quand le prix ne représente pas le prix du marché

plot$prix_achat_hectare[plot$prix_achat_hectare ==  25 ] =  NA
plot$prix_achat_hectare[plot$prix_achat_hectare ==  185714 ] =  185000
plot$prix_achat_hectare[plot$prix_achat_hectare ==  0 ] =  NA
plot$prix_achat_hectare[plot$prix_achat_hectare ==  0 ] =  NA
plot$prix_achat_hectare[plot$prix_achat_hectare ==  0 ] =  NA


plot_sum = aggregate(. ~ id, FUN = sum, na.rm = TRUE, data = plot[, c(1, 3:32, 38, 33)])

plot_sum = merge(agr[, c(1, 8:19, 23:31)], plot_sum, by = "id")

plot_sum$safoutier = plot_sum$safoutier + plot_sum$safou.x + plot_sum$safou.y
plot_sum$cacao.x = plot_sum$cacao.x + plot_sum$cacao.y
plot_sum$cafe.x = plot_sum$cafe.x + plot_sum$cafe.y
plot_sum$bananier = plot_sum$bananier + plot_sum$banane
plot_sum$plantain.x = plot_sum$plantain.x + plot_sum$plantain.y
plot_sum$palmier.x = plot_sum$palmier.x + plot_sum$palmier.y
plot_sum$manguier.x = plot_sum$manguier.x + plot_sum$manguier.y
plot_sum$avocatier.x = plot_sum$avocatier.x + plot_sum$avocatier.y
plot_sum$ananas.x = plot_sum$ananas.x + plot_sum$ananas.y
plot_sum$agrumes.x = plot_sum$agrumes.x + plot_sum$agrumes.y
plot_sum$litchi.x = plot_sum$litchi.x + plot_sum$litchi.y
plot_sum$manioc.x = plot_sum$manioc.x + plot_sum$manioc.y
plot_sum$mais.x = plot_sum$mais.x + plot_sum$mais.y
plot_sum$soja.x = plot_sum$soja.x + plot_sum$soja.y
plot_sum$arachide.x = plot_sum$arachide.x + plot_sum$arachide.y

plot_sum = plot_sum[, c(1, 14:17, 24:25, 29:34, 36:38, 49:51, 2:13, 52:54)]

names(plot_sum)[2] = "manioc"
names(plot_sum)[3] = "mais"
names(plot_sum)[4] = "soja"
names(plot_sum)[5] = "arachide"
names(plot_sum)[7] = "autres_tubercules"
names(plot_sum)[15] = "legumes_feuilles"
names(plot_sum)[16] = "legumes_fruits"
names(plot_sum)[21] = "cacao"
names(plot_sum)[22] = "cafe"
names(plot_sum)[24] = "plantain"
names(plot_sum)[25] = "palmier"
names(plot_sum)[26] = "manguier"
names(plot_sum)[27] = "avocatier"
names(plot_sum)[28] = "ananas"
names(plot_sum)[29] = "agrumes"
names(plot_sum)[30] = "litchi"
names(plot_sum)[31] = "autres_arbres_outside_fields"
names(plot_sum)[32] = "autres_arbres_fruitiers_inside_fields"
names(plot_sum)[33] = "autres_arbres_nonfruitiers_inside_fields"
names(plot_sum)[34] = "cultivated_area"

plot_sum$manioc = ifelse(plot_sum$manioc > 0, 1, 0)
plot_sum$mais = ifelse(plot_sum$mais > 0, 1, 0)
plot_sum$soja = ifelse(plot_sum$soja > 0, 1, 0)
plot_sum$arachide = ifelse(plot_sum$arachide > 0, 1, 0)
plot_sum$igname = ifelse(plot_sum$igname > 0, 1, 0)
plot_sum$autres_tubercules = ifelse(plot_sum$autres_tubercules > 0, 1, 0)
plot_sum$riz = ifelse(plot_sum$riz > 0, 1, 0)
plot_sum$sorgho = ifelse(plot_sum$sorgho > 0, 1, 0)
plot_sum$haricot = ifelse(plot_sum$haricot > 0, 1, 0)
plot_sum$pois_dangole = ifelse(plot_sum$pois_dangole > 0, 1, 0)
plot_sum$lentille = ifelse(plot_sum$lentille > 0, 1, 0)
plot_sum$sesame = ifelse(plot_sum$sesame > 0, 1, 0)
plot_sum$pasteque = ifelse(plot_sum$pasteque > 0, 1, 0)
plot_sum$legumes_feuilles = ifelse(plot_sum$legumes_feuilles > 0, 1, 0)
plot_sum$legumes_fruits = ifelse(plot_sum$legumes_fruits > 0, 1, 0)
plot_sum$ramboutan = ifelse(plot_sum$ramboutan > 0, 1, 0)
plot_sum$papaye = ifelse(plot_sum$papaye > 0, 1, 0)
plot_sum$canne_a_sucre = ifelse(plot_sum$canne_a_sucre > 0, 1, 0)
plot_sum$safoutier = ifelse(plot_sum$safoutier > 0, 1, 0)
plot_sum$cacao = ifelse(plot_sum$cacao > 0, 1, 0)
plot_sum$cafe = ifelse(plot_sum$cafe > 0, 1, 0)
plot_sum$plantain = ifelse(plot_sum$plantain > 0, 1, 0)
plot_sum$bananier = ifelse(plot_sum$bananier > 0, 1, 0)
plot_sum$palmier = ifelse(plot_sum$palmier > 0, 1, 0)
plot_sum$manguier = ifelse(plot_sum$manguier > 0, 1, 0)
plot_sum$avocatier = ifelse(plot_sum$avocatier > 0, 1, 0)
plot_sum$ananas = ifelse(plot_sum$ananas > 0, 1, 0)
plot_sum$agrumes = ifelse(plot_sum$agrumes > 0, 1, 0)
plot_sum$litchi = ifelse(plot_sum$litchi > 0, 1, 0)
plot_sum$autres_arbres_outside_fields = ifelse(plot_sum$autres_arbres_outside_fields > 0, 1, 0)
plot_sum$autres_arbres_fruitiers_inside_fields = ifelse(plot_sum$autres_arbres_fruitiers_inside_fields > 0, 1, 0)
plot_sum$autres_arbres_nonfruitiers_inside_fields = ifelse(plot_sum$autres_arbres_nonfruitiers_inside_fields > 0, 1, 0)

plot_sum$diversite_annual = rowSums(plot_sum[, c(2:19, 28)])
plot_sum$diversite_perenial = rowSums(plot_sum[, c(20:27, 29:33)])
plot_sum$diversite_total = plot_sum$diversite_annual + plot_sum$diversite_perenial

# write.xlsx(plot_sum, file = "Input_files\\6.3. Diversité cultures.xlsx")


# 6.3.1 Prix de la location/village

loc_CFA=plot[,c(1,2,33,41)]
loc_CFA$prix_loc=as.numeric(loc_CFA$prix_loc)
loc_CFA=filter(loc_CFA, !is.na(prix_loc))

loc_CFA = right_join(loc_CFA,loc, by="id") 
loc_CFA =loc_CFA[,c(1:7)]

#Je pense qu'il y a eu des incompréhensions dans la saisie des prix à l'hectare en location 
loc_CFA <- loc_CFA %>% mutate(prix_loc_1ha = ifelse(plot_surface > 1,  prix_loc, prix_loc / plot_surface))
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==2501] = 75000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==2500] = 75000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==34] = 50000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==35] = 50000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==33] = 55000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==310] = 25000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==2268] = 30000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==1355] = 20000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==1356] = 20000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==1357] = 20000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==1524] = 20000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==1525] = 20000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==2383] = 20000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==2384] = 20000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==325] = 30000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==326] = 30000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==9] = 25000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==27] = 25000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==1282] = 15000
loc_CFA$prix_loc_1ha[loc_CFA$ch_id==127] = 20000
loc_CFA = loc_CFA %>% mutate(cout_location_terres = prix_loc_1ha*plot_surface)

#en gros faire une fonction on fait la moyenne ou la somme des colonnes pour chaque ID. 
loc_CFA <- loc_CFA %>% group_by(id) %>% summarise(surface_cultivee_louee = sum(plot_surface, na.rm = TRUE),
  prix_loc_1ha = mean(prix_loc_1ha, na.rm = TRUE),
  cout_location_terres = sum(cout_location_terres, na.rm = TRUE),
   departement = unique(departement),
   district = unique(district),
   village=unique(village)
  )

loc_CFA= right_join(loc_CFA,plot_sum, by="id" )
loc_CFA = loc_CFA[,c(1:7, 40)]
loc_CFA = loc_CFA[,c(1,8,2:7)]

# write.xlsx(loc_CFA, file = "Input_files\\6.3.1 Prix location.xlsx")

# achat 
achat_CFA=plot[,c(1,2,33,46)]
achat_CFA$prix_achat_hectare=as.numeric(achat_CFA$prix_achat_hectare)
achat_CFA=filter(achat_CFA, !is.na(prix_achat_hectare))

achat_CFA = right_join(achat_CFA,loc, by="id") 
achat_CFA =achat_CFA[,c(1:7)]

achat_CFA$prix_achat_hectare[achat_CFA$ch_id==344] = NA

achat_CFA = achat_CFA %>% mutate(cout_achat_terres = prix_achat_hectare*plot_surface)

achat_CFA <- achat_CFA %>% group_by(id) %>% summarise(surface_cultivee_achetee = sum(plot_surface, na.rm = TRUE),
                                                  prix_achat_hectare = mean(prix_achat_hectare, na.rm = TRUE),
                                                  cout_achat_terres = sum(cout_achat_terres, na.rm = TRUE),
                                                  departement = unique(departement),
                                                  district = unique(district),
                                                  village=unique(village)
)

achat_CFA= right_join(achat_CFA,plot_sum, by="id" )
achat_CFA = achat_CFA[,c(1:7, 40)]
achat_CFA = achat_CFA[,c(1,8,2:7)]


# write.xlsx(achat_CFA, file = "Input_files\\6.3.2 Prix achat.xlsx")

#achat_loc_CFA= bind_cols(loc_CFA,achat_CFA[c(3:5)])
#achat_loc_CFA=achat_loc_CFA[,c(1:5,9:11,6:8)]

# 6.4. Cultures prioritaires
# 6.4.1. Manioc

man = data[, c(732, 108:116, 117:161)]

man[, c(25:27, 29:31, 33:35, 37:39, 41:43, 45:47, 49:51, 53:55)][is.na(man[, c(25:27, 29:31, 33:35, 37:39, 41:43, 45:47, 49:51, 53:55)])] = 0

man[, c(25:27, 29:31, 33:35, 37:39, 41:43, 45:47, 49:51, 53:55)] = abs(man[, c(25:27, 29:31, 33:35, 37:39, 41:43, 45:47, 49:51, 53:55)])

names(man) = c("id", "bout_autoprod", "bout_voisin", "bout_magasin", "bout_pepiniere", "bout_projet", "bout_prive", "bout_publique",
               "part_autoconso", "part_vendue", "materiel_transfo", "materiel_transfo_precisez", "moulin", "forme_vente",
               "chikwangue", "cossettes", "roui", "foufou_cossettes", "foufou_emiette", "tubercule_frais", "autre", "farine_foufou", "gari",
               "unité_vente_chikwangue", "masse_unité_chikwangue", "prix_unité_chikwangue", "nb_ventes_chikwangue",
               "unité_vente_cossettes","masse_unité_cossettes", "prix_unité_cossettes", "nb_ventes_cossettes", 
               "unité_vente_tuber_roui","masse_unité_tuber_roui", "prix_unité_tuber_roui", "nb_ventes_tuber_roui",
               "unité_vente_farine_foufou","masse_unité_farine_foufou", "prix_unité_farine_foufou", "nb_ventes_farine_foufou",
               "unité_vente_foufou_emietté","masse_unité_foufou_emietté", "prix_unité_foufou_emietté", "nb_ventes_foufou_emietté",
               "unité_vente_tuber_frais","masse_unité_tuber_frais", "prix_unité_tuber_frais", "nb_ventes_tuber_frais",
               "unité_vente_gari","masse_unité_gari", "prix_unité_gari", "nb_ventes_gari",
               "unité_vente_autre","masse_unité_autre", "prix_unité_autre", "nb_ventes_autre")

# CHIKWANGUE (pain de manioc) : Objectif: Pour chaque prix de vente, association d'une masse correspondante
man$unité_vente_chikwangue[man$unité_vente_chikwangue=="Unité"]="Pain"

# a. Mais on constate des anomalies donc suppression des valeurs étranges pour les unités de vente autres que Kilo et Pain
man[!is.na(man$unité_vente_chikwangue) & man$unité_vente_chikwangue == "Cuvette", -c(1:23)] = NA
man[!is.na(man$unité_vente_chikwangue) & man$unité_vente_chikwangue == "Panier", -c(1:23)] = NA
# man[!is.na(man$unité_vente_chikwangue) & man$unité_vente_chikwangue == "Sac", -c(1:3)] = NA
# man[!is.na(man$unité_vente_chikwangue) & man$unité_vente_chikwangue == "Tas", -c(1:3)] = NA

# b. identification des outliers sur "masse_unité_chikwangue" 
f=function(x) ifelse(man$masse_unité_chikwangue>=50, NA, x)
man=man %>% mutate(across(.cols = c(24:55), .fns=f))
man$masse_unité_chikwangue[man$masse_unité_chikwangue==0.05]=0.5
man$masse_unité_chikwangue[man$masse_unité_chikwangue==0.04]=0.4
man$masse_unité_chikwangue[man$masse_unité_chikwangue==0.03]=0.3
man$masse_unité_chikwangue[man$masse_unité_chikwangue==0.01]=0.1

# c. identification des outliers sur "prix_unité_chikwangue" 
f=function(x) ifelse(man$prix_unité_chikwangue>10000, NA, x)
man=man %>% mutate(across(.cols = c(24:55), .fns=f))
f=function(x) ifelse(man$prix_unité_chikwangue<=50, NA, x)
man=man %>% mutate(across(.cols = c(24:55), .fns=f))

# d. identification des outliers sur "nombre_ventes_chikwangue". On considère que toute la production >50t/ha résulte d'erreures de saisie
man=left_join(man,plot_sum %>% select(id, cultivated_area), by="id")
man= man %>% mutate(rdt_man_chikw=(masse_unité_chikwangue*nb_ventes_chikwangue)/cultivated_area)
f=function(x) ifelse(man$rdt_man_chikw>50000, NA, x)
man=man %>% mutate(across(.cols = c(24:55,57), .fns=f))

# e. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(man$nb_ventes_chikwangue==0, 0, x)
man=man %>% mutate(across(.cols = c(25:27), .fns=f))
f=function(x) ifelse(man$nb_ventes_chikwangue==0, NA, x)
man=man %>% mutate(across(.cols = 24, .fns=f))

# f. On ajoute une colonne "Département" au tableau man en fonction la jointure avec "id"
man=left_join(man,loc %>% select(id, departement), by="id")

rdt_chik_dpt = man %>%
  group_by(departement, unité_vente_chikwangue, prix_unité_chikwangue) %>%
  summarise(masse_moyenne_chkw=mean(masse_unité_chikwangue[masse_unité_chikwangue != 0], na.rm = TRUE)) 

rdt_chik_dpt= filter(rdt_chik_dpt, !is.na(masse_moyenne_chkw) & masse_moyenne_chkw != 0)

#g.Pour chaque combinaison departement*unité*prix, on associe la masse correspondante
man <- man %>%
  left_join(rdt_chik_dpt, by = c("departement", "unité_vente_chikwangue", "prix_unité_chikwangue")) %>%
  mutate(masse_unité_chikwangue = ifelse(masse_unité_chikwangue == 0, masse_moyenne_chkw, masse_unité_chikwangue)) %>%
  select(-masse_moyenne_chkw)  

man$masse_unité_chikwangue[man$id==187]=3
man$masse_unité_chikwangue[man$id==188]=15

# COSSETTES : Objectif: Pour chaque prix de vente, association d'une masse correspondante
# summary(as.factor(man$unité_vente_cossettes))
man$unité_vente_chikwangue[man$unité_vente_cossettes=="Pain"]="Sac"

#c. #identification des outliers sur "masse_unité_cossettes" 
# ggplot(man, aes(x=unité_vente_cossettes, y=masse_unité_cossettes)) + geom_boxplot(outlier.colour="red",outlier.size=2)
f=function(x) ifelse(man$masse_unité_cossettes>=302, NA, x)
man=man %>% mutate(across(.cols = c(24:55), .fns=f))
man$masse_unité_cossettes[man$id==273]=30
man$masse_unité_cossettes[man$id==902]=15

# d. identification des outliers sur "prix_unité_cossettes" 
# ggplot(man, aes(x=unité_vente_cossettes, y=prix_unité_cossettes)) + geom_boxplot(outlier.colour="red",outlier.size=2)
f=function(x) ifelse(man$prix_unité_cossettes>50000, NA, x)
man=man %>% mutate(across(.cols = c(24:55), .fns=f))
man$prix_unité_cossettes[man$id==33]=2000
man$prix_unité_cossettes[man$id==75]=10000

# e. identification des outliers sur "nombre_ventes_cossettes". On considère que toute la production >50t/ha résulte d'erreures de saisie
# ggplot(man, aes(x=unité_vente_cossettes, y=nb_ventes_cossettes)) + geom_boxplot(outlier.colour="red",outlier.size=2)
man= man %>% mutate(rdt_man_cossettes=(masse_unité_cossettes*nb_ventes_cossettes)/cultivated_area)
f=function(x) ifelse(man$rdt_man_cossettes>50000, NA, x)
man=man %>% mutate(across(.cols = c(24:55,57,59), .fns=f))

# f. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(man$nb_ventes_cossettes==0, 0, x)
man=man %>% mutate(across(.cols = c(29:31), .fns=f))
f=function(x) ifelse(man$nb_ventes_cossettes==0, NA, x)
man=man %>% mutate(across(.cols = 28, .fns=f))

# g. On ajoute une colonne "Département" au tableau man en fonction la jointure avec "id"
rdt_cossettes_dpt= man %>%
  group_by(departement, unité_vente_cossettes, prix_unité_cossettes) %>%
  summarise(masse_moyenne_cossettes=mean(masse_unité_cossettes[masse_unité_cossettes != 0], na.rm = TRUE)) 

rdt_cossettes_dpt= filter(rdt_cossettes_dpt, !is.na(masse_moyenne_cossettes) & masse_moyenne_cossettes != 0)

# h.Pour chaque combinaison departement*unité*prix, on associe la masse correspondante
man <- man %>%
  left_join(rdt_cossettes_dpt, by = c("departement", "unité_vente_cossettes", "prix_unité_cossettes")) %>%
  mutate(masse_unité_cossettes = ifelse(masse_unité_cossettes == 0, masse_moyenne_cossettes, masse_unité_cossettes)) %>%
  select(-masse_moyenne_cossettes)  

man$masse_unité_cossettes[man$id==188]=20
man$masse_unité_cossettes[man$id==989]=20
man$masse_unité_cossettes[man$id==749]=15
man$masse_unité_cossettes[man$id==947]=50
man$masse_unité_cossettes[man$id==993]=80


# TUBERCULES ROUIS: Objectif: Pour chaque prix de vente, association d'une masse correspondante
# summary(as.factor(man$unité_vente_tuber_roui))

# c. identification des outliers sur "masse_unité_tuber_roui" 
# ggplot(man, aes(x=unité_vente_tuber_roui, y=masse_unité_tuber_roui)) + geom_boxplot(outlier.colour="red",outlier.size=2)

# d. identification des outliers sur "prix_unité_tuber_roui" 
# ggplot(man, aes(x=unité_vente_tuber_roui, y=prix_unité_tuber_roui)) + geom_boxplot(outlier.colour="red",outlier.size=2)

# e. identification des outliers sur "nombre_ventes_tuber_roui". On considère que toute la production >50t/ha résulte d'erreures de saisie
# ggplot(man, aes(x=unité_vente_tuber_roui, y=nb_ventes_tuber_roui)) + geom_boxplot(outlier.colour="red",outlier.size=2)
man= man %>% mutate(rdt_man_tuber_roui=(masse_unité_tuber_roui*nb_ventes_tuber_roui)/cultivated_area)
f=function(x) ifelse(man$rdt_man_tuber_roui>50000, NA, x)
man=man %>% mutate(across(.cols = c(24:55,57,59,60), .fns=f))

# f. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(man$nb_ventes_tuber_roui==0, 0, x)
man=man %>% mutate(across(.cols = c(33:35), .fns=f))
f=function(x) ifelse(man$nb_ventes_tuber_roui==0, NA, x)
man=man %>% mutate(across(.cols = 32, .fns=f))

# g. On ajoute une colonne "Département" au tableau man en fonction la jointure avec "id"
rdt_tuber_roui_dpt= man %>%
  group_by(departement, unité_vente_tuber_roui, prix_unité_tuber_roui) %>%
  summarise(masse_moyenne_tuber_roui=mean(masse_unité_tuber_roui[masse_unité_tuber_roui != 0], na.rm = TRUE)) 

rdt_tuber_roui_dpt= filter(rdt_tuber_roui_dpt, !is.na(masse_moyenne_tuber_roui) & masse_moyenne_tuber_roui != 0)

# h.Pour chaque combinaison departement*unité*prix, on associe la masse correspondante
man <- man %>%
  left_join(rdt_tuber_roui_dpt, by = c("departement", "unité_vente_tuber_roui", "prix_unité_tuber_roui")) %>%
  mutate(masse_unité_tuber_roui = ifelse(masse_unité_tuber_roui == 0, masse_moyenne_tuber_roui, masse_unité_tuber_roui)) %>%
  select(-masse_moyenne_tuber_roui)  

# FARINE FOUFOU: Objectif: Pour chaque prix de vente, association d'une masse correspondante
# summary(as.factor(man$unité_vente_farine_foufou))

# c. identification des outliers sur "masse_unité_farine_foufou" 
# ggplot(man, aes(x=unité_vente_farine_foufou, y=masse_unité_farine_foufou)) + geom_boxplot(outlier.colour="red",outlier.size=2)

# d. identification des outliers sur "prix_unité_farine_foufou" 
# ggplot(man, aes(x=unité_vente_farine_foufou, y=prix_unité_farine_foufou)) + geom_boxplot(outlier.colour="red",outlier.size=2)

# e. identification des outliers sur "nombre_ventes_farine_foufou". On considère que toute la production >50t/ha résulte d'erreures de saisie
# ggplot(man, aes(x=unité_vente_farine_foufou, y=nb_ventes_farine_foufou)) + geom_boxplot(outlier.colour="red",outlier.size=2)

# f. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(man$nb_ventes_farine_foufou==0, 0, x)
man=man %>% mutate(across(.cols = c(37:39), .fns=f))
f=function(x) ifelse(man$nb_ventes_farine_foufou==0, NA, x)
man=man %>% mutate(across(.cols = 36, .fns=f))

# g. On ajoute une colonne "Département" au tableau man en fonction la jointure avec "id"
rdt_farine_foufou_dpt= man %>%
  group_by(departement, unité_vente_farine_foufou, prix_unité_farine_foufou) %>%
  summarise(masse_moyenne_farine_foufou=mean(masse_unité_farine_foufou[masse_unité_farine_foufou != 0], na.rm = TRUE)) 

rdt_farine_foufou_dpt= filter(rdt_farine_foufou_dpt, !is.na(masse_moyenne_farine_foufou) & masse_moyenne_farine_foufou != 0)


# FOUFOU EMIETTE : Objectif: Pour chaque prix de vente, association d'une masse correspondante
# summary(as.factor(man$unité_vente_foufou_emietté))

# c. identification des outliers sur "masse_unité_foufou_emietté" 
# ggplot(man, aes(x=unité_vente_foufou_emietté, y=masse_unité_foufou_emietté)) + geom_boxplot(outlier.colour="red",outlier.size=2)
f=function(x) ifelse(man$masse_unité_foufou_emietté>100, NA, x)
man=man %>% mutate(across(.cols = c(24:55,57,59,60), .fns=f))

#d. #identification des outliers sur "prix_unité_foufou_emietté" 
# ggplot(man, aes(x=unité_vente_foufou_emietté, y=prix_unité_foufou_emietté)) + geom_boxplot(outlier.colour="red",outlier.size=2)

#e. #identification des outliers sur "nombre_ventes_foufou_emietté". On considère que toute la production >50t/ha résulte d'erreures de saisie
# ggplot(man, aes(x=unité_vente_foufou_emietté, y=nb_ventes_foufou_emietté)) + geom_boxplot(outlier.colour="red",outlier.size=2)
man= man %>% mutate(rdt_man_foufou_emietté=(masse_unité_foufou_emietté*nb_ventes_foufou_emietté)/cultivated_area)
f=function(x) ifelse(man$rdt_man_foufou_emietté>50000, NA, x)
man=man %>% mutate(across(.cols = c(24:55,57,59:61), .fns=f))

#f. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(man$nb_ventes_foufou_emietté==0, 0, x)
man=man %>% mutate(across(.cols = c(41:43), .fns=f))
f=function(x) ifelse(man$nb_ventes_foufou_emietté==0, NA, x)
man=man %>% mutate(across(.cols = 40, .fns=f))


# TUBER FRAIS: Objectif: Pour chaque prix de vente, association d'une masse correspondante

# c. identification des outliers sur "masse_unité_tuber_frais" 
# ggplot(man, aes(x=unité_vente_tuber_frais, y=masse_unité_tuber_frais)) + geom_boxplot(outlier.colour="red",outlier.size=2)

#d. #identification des outliers sur "prix_unité_tuber_frais" 
# ggplot(man, aes(x=unité_vente_tuber_frais, y=prix_unité_tuber_frais)) + geom_boxplot(outlier.colour="red",outlier.size=2)
f=function(x) ifelse(man$prix_unité_tuber_frais>20000, NA, x)
man=man %>% mutate(across(.cols = c(24:55,57, 59:61), .fns=f))
man$prix_unité_tuber_frais[man$id==769]=2000
man$prix_unité_tuber_frais[man$id==387]=5000

# e. identification des outliers sur "nombre_ventes_tuber_frais". On considère que toute la production >50t/ha résulte d'erreures de saisie
# ggplot(man, aes(x=unité_vente_tuber_frais, y=nb_ventes_tuber_frais)) + geom_boxplot(outlier.colour="red",outlier.size=2)
man= man %>% mutate(rdt_man_tuber_frais=(masse_unité_tuber_frais*nb_ventes_tuber_frais)/cultivated_area)
f=function(x) ifelse(man$rdt_man_tuber_frais>50000, NA, x)
man=man %>% mutate(across(.cols = c(24:55,57, 59:61), .fns=f))

# f. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(man$nb_ventes_tuber_frais==0, 0, x)
man=man %>% mutate(across(.cols = c(45:47), .fns=f))
f=function(x) ifelse(man$nb_ventes_tuber_frais==0, NA, x)
man=man %>% mutate(across(.cols = 44, .fns=f))

# g. On ajoute une colonne "Département" au tableau man en fonction la jointure avec "id"
rdt_tuber_frais_dpt= man %>%
  group_by(departement, unité_vente_tuber_frais, prix_unité_tuber_frais) %>%
  summarise(masse_moyenne_tuber_frais=mean(masse_unité_tuber_frais[masse_unité_tuber_frais != 0], na.rm = TRUE)) 

rdt_tuber_frais_dpt= filter(rdt_tuber_frais_dpt, !is.na(masse_moyenne_tuber_frais) & masse_moyenne_tuber_frais != 0)

# h.Pour chaque combinaison departement*unité*prix, on associe la masse correspondante
man <- man %>%
  left_join(rdt_tuber_frais_dpt, by = c("departement", "unité_vente_tuber_frais", "prix_unité_tuber_frais")) %>%
  mutate(masse_unité_tuber_frais = ifelse(masse_unité_tuber_frais == 0, masse_moyenne_tuber_frais, masse_unité_tuber_frais)) %>%
  select(-masse_moyenne_tuber_frais)  
man$masse_unité_tuber_frais[man$id==828]=70


# AUTRE: Objectif: Pour chaque prix de vente, association d'une masse correspondante
# summary(as.factor(man$unité_vente_autre))

# c. identification des outliers sur "masse_unité_autre" 
# ggplot(man, aes(x=unité_vente_autre, y=masse_unité_autre)) + geom_boxplot(outlier.colour="red",outlier.size=2)

#d. #identification des outliers sur "prix_unité_autre" 
# ggplot(man, aes(x=unité_vente_autre, y=prix_unité_autre)) + geom_boxplot(outlier.colour="red",outlier.size=2)
f=function(x) ifelse(man$prix_unité_autre>50000, NA, x)
man=man %>% mutate(across(.cols = c(24:55,57,59:60), .fns=f))

#e. #identification des outliers sur "nombre_ventes_autre". On considère que toute la production >50t/ha résulte d'erreures de saisie
# ggplot(man, aes(x=unité_vente_autre, y=nb_ventes_autre)) + geom_boxplot(outlier.colour="red",outlier.size=2)
man= man %>% mutate(rdt_man_autre=(masse_unité_autre*nb_ventes_autre)/cultivated_area)


#man <- man %>%  select(-c(57, 59:63)) %>% mutate(rdt_manioc = (
      #replace_na(masse_unité_chikwangue, 0) * replace_na(nb_ventes_chikwangue, 0) +
      #  replace_na(masse_unité_cossettes, 0) * replace_na(nb_ventes_cossettes, 0) +
       # replace_na(masse_unité_tuber_roui, 0) * replace_na(nb_ventes_tuber_roui, 0) +
        #replace_na(masse_unité_farine_foufou, 0) * replace_na(nb_ventes_farine_foufou, 0) +
        #replace_na(masse_unité_foufou_emietté, 0) * replace_na(nb_ventes_foufou_emietté, 0) +
        #replace_na(masse_unité_tuber_frais, 0) * replace_na(nb_ventes_tuber_frais, 0) +
        #replace_na(masse_unité_autre, 0) * replace_na(nb_ventes_autre, 0)
    #) / cultivated_area) # A rapporter a la production totale (conso+vendue)
  

# 0.8 kg chikwangue = 1 kg tubercules frais
# 0.5 kg cossettes = 1 kg tubercules frais
# 0.5 kg foufou émietté = 1 kg tubercules frais
# 0.5 kg foufou farine = 1 kg tubercules frais
# 0.9 kg tubercules rouis = 1 kg tubercules frais
# 0.3 kg gari = 1 kg tubercules frais

# La fonction ne considère pas les NA, je te propose plutot de faire cela:
#man$manioc_sale = 0.8 * man$masse_unité_chikwangue * man$nb_ventes_chikwangue +
#  0.5 * man$masse_unité_cossettes * man$nb_ventes_cossettes +
#  0.9 * man$masse_unité_tuber_roui * man$nb_ventes_tuber_roui +
 # 0.5 * man$masse_unité_farine_foufou * man$nb_ventes_farine_foufou +
 # 0.5 * man$masse_unité_foufou_emietté * man$nb_ventes_foufou_emietté +
 # man$masse_unité_tuber_frais * man$nb_ventes_tuber_frais +
 # 0.3 * man$masse_unité_gari * man$nb_ventes_gari

man$manioc_sale = 
  0.8 * replace_na(man$masse_unité_chikwangue, 0) * replace_na(man$nb_ventes_chikwangue, 0) +
  0.5 * replace_na(man$masse_unité_cossettes, 0) * replace_na(man$nb_ventes_cossettes, 0) +
  0.9 * replace_na(man$masse_unité_tuber_roui, 0) * replace_na(man$nb_ventes_tuber_roui, 0) +
  0.5 * replace_na(man$masse_unité_farine_foufou, 0) * replace_na(man$nb_ventes_farine_foufou, 0) +
  0.5 * replace_na(man$masse_unité_foufou_emietté, 0) * replace_na(man$nb_ventes_foufou_emietté, 0) +
  replace_na(man$masse_unité_tuber_frais, 0) * replace_na(man$nb_ventes_tuber_frais, 0) +
  0.3 * replace_na(man$masse_unité_gari, 0) * replace_na(man$nb_ventes_gari, 0)

man$part_autoconso = as.numeric(sub("%", "", man$part_autoconso))
man$part_vendue = as.numeric(sub("%", "", man$part_vendue))

man$part_totale = man$part_autoconso + man$part_vendue

man$part_autoconso = ifelse(man$part_totale > 100 | man$part_totale < 100,
                            man$part_autoconso * 100 / man$part_totale, man$part_autoconso)

man$part_vendue = ifelse(man$part_totale > 100 | man$part_totale < 100,
                         man$part_vendue * 100 / man$part_totale, man$part_vendue)

man$manioc_production = 100 * man$manioc_sale / man$part_vendue

man$manioc_production[is.na(man$manioc_production)] = 0

man = man[!is.na(man$part_totale),]

man = man[ (man$part_totale > 0),]

man$manioc_revenus = man$prix_unité_chikwangue * man$nb_ventes_chikwangue +
  man$prix_unité_cossettes * man$nb_ventes_cossettes +
  man$prix_unité_tuber_roui * man$nb_ventes_tuber_roui +
  man$prix_unité_farine_foufou * man$nb_ventes_farine_foufou +
  man$prix_unité_foufou_emietté * man$nb_ventes_foufou_emietté +
  man$prix_unité_tuber_frais * man$nb_ventes_tuber_frais +
  man$prix_unité_gari * man$nb_ventes_gari

man = merge(man, man_mai_ara_saf_pla[, c(1:2)], by = "id")

man$rend_manioc = ifelse(man$surf_manioc == 0, NA, man$manioc_production / man$surf_manioc)


par(mar=c(2,2,2,2))
# boxplot(man$rend_manioc)
man$rend_manioc = ifelse(man$rend_manioc > 60000, NA, man$rend_manioc)
# boxplot(man$rend_manioc)

# man$rend_manioc = ifelse(man$rend_manioc > mean(na.omit(man$rend_manioc)) + 2 * IQR(na.omit(man$rend_manioc)), NA, man$rend_manioc)
# boxplot(man$rend_manioc)
# man$rend_manioc = ifelse(man$rend_manioc > mean(na.omit(man$rend_manioc)) + 2 * IQR(na.omit(man$rend_manioc)), NA, man$rend_manioc)
# boxplot(man$rend_manioc)

# mean(na.omit(man$rend_manioc))

# rdt_manioc = mean(na.omit(man$rend_manioc))
rdt_manioc = mean(man$rend_manioc[man$rend_manioc != 0], na.rm = TRUE)
# rdt_manioc

# write.xlsx(man, file = "Input_files\\6.4.1. Manioc.xlsx")

man_mai_ara_saf_pla = merge(man_mai_ara_saf_pla, man[, c(1, 10)], by = "id", all.x = TRUE)
names(man_mai_ara_saf_pla)[8] = "part_vendue_manioc"


# 6.4.2. Maïs

mai = data[, c(732, 163:174, 176, 178:201)]

names(mai) = c("id", "sem_autoprod", "sem_voisin", "sem_magasin", "sem_pepiniere", "sem_projet", "sem_prive", "sem_publique",
               "part_autoconso", "part_vendue", "part_alim_animale", "broyeur", "statut_broyeur", "epis", "gritz", "farine", "autre", "grains",
               "unité_vente_epis", "masse_unité_epis", "prix_unité_epis", "nb_ventes_epis",
               "unité_vente_grains", "masse_unité_grains", "prix_unité_grains", "nb_ventes_grains",
               "unité_vente_gritz", "masse_unité_gritz", "prix_unité_gritz", "nb_ventes_gritz",
               "unité_vente_farine", "masse_unité_farine", "prix_unité_farine", "nb_ventes_farine",
               "unité_vente_autre", "masse_unité_autre", "prix_unité_autre", "nb_ventes_autre")

mai[, c(20:22, 24:26, 28:30, 32:34, 36:38)][is.na(mai[, c(20:22, 24:26, 28:30, 32:34, 36:38)])] = 0

mai[, c(20:22, 24:26, 28:30, 32:34, 36:38)] = abs(mai[, c(20:22, 24:26, 28:30, 32:34, 36:38)])


# EPIS : Objectif: Pour chaque prix de vente, association d'une masse correspondante

# a. identification des outliers sur "masse_unité_epis" 

# b. identification des outliers sur "prix_unité_epis" 

# c. identification des outliers sur "nombre_ventes_epis". On considère que toute la production >50t/ha résulte d'erreures de saisie
mai=left_join(mai,plot_sum %>% select(id, cultivated_area), by="id")
mai= mai %>% mutate(rdt_mai_epis=(masse_unité_epis*nb_ventes_epis)/cultivated_area)
f=function(x) ifelse(mai$rdt_mai_epis>100000, NA, x)
mai=mai %>% mutate(across(.cols = c(20:40), .fns=f))

# d. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(mai$nb_ventes_epis==0, 0, x)
mai=mai %>% mutate(across(.cols = c(20:22), .fns=f))
f=function(x) ifelse(mai$nb_ventes_epis==0, NA, x)
mai=mai %>% mutate(across(.cols = 19, .fns=f))

# GRAINS : Objectif: Pour chaque prix de vente, association d'une masse correspondante

# a. identification des outliers sur "masse_unité_grains" 

# c. identification des outliers sur "prix_unité_grains" 

# d. identification des outliers sur "nombre_ventes_grains". On considère que toute la production >50t/ha résulte d'erreures de saisie
mai= mai %>% mutate(rdt_mai_grains=(masse_unité_grains*nb_ventes_grains)/cultivated_area)
f=function(x) ifelse(mai$rdt_mai_grains>100000, NA, x)
mai=mai %>% mutate(across(.cols = c(20:41), .fns=f))

# e. Si ventes = 0, alors "masse" et "prix" = 0
f=function(x) ifelse(mai$nb_ventes_grains==0, 0, x)
mai=mai %>% mutate(across(.cols = c(24:26), .fns=f))
f=function(x) ifelse(mai$nb_ventes_grains==0, NA, x)
mai=mai %>% mutate(across(.cols = 23, .fns=f))

#f. On ajoute une colonne "Département" au tableau man en fonction la jointure avec "id"
mai=left_join(mai,loc %>% select(id, departement), by="id")

rdt_grains_dpt= mai %>%
  group_by(departement, unité_vente_grains, prix_unité_grains) %>%
  summarise(masse_moyenne_grains=mean(masse_unité_grains[masse_unité_grains != 0], na.rm = TRUE)) 

rdt_grains_dpt= filter(rdt_grains_dpt, !is.na(masse_moyenne_grains) & masse_moyenne_grains != 0)

#h. Pour chaque combinaison departement*unité*prix, on associe la masse correspondante
mai <- mai %>%
  left_join(rdt_grains_dpt, by = c("departement", "unité_vente_grains", "prix_unité_grains")) %>%
  mutate(masse_unité_grains = ifelse(masse_unité_grains == 0, masse_moyenne_grains, masse_unité_grains)) %>%
  select(-masse_moyenne_grains)  

mai$masse_unité_grains[mai$id==57]= 50
mai$masse_unité_grains[mai$id==6]=10

# AUTRE : Objectif: Pour chaque prix de vente, association d'une masse correspondante

# a. identification des outliers sur "masse_unité_grains" 

#c. #identification des outliers sur "prix_unité_grains" 

#d. #identification des outliers sur "nombre_ventes_grains". On considère que toute la production >50t/ha résulte d'erreures de saisie
mai= mai %>% mutate(rdt_mai_autre=(masse_unité_autre*nb_ventes_autre)/cultivated_area)
f=function(x) ifelse(mai$rdt_mai_autre>100000, NA, x)
mai=mai %>% mutate(across(.cols = c(20:42), .fns=f))

# e. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(mai$nb_ventes_autre==0, 0, x)
mai=mai %>% mutate(across(.cols = c(36:38), .fns=f))
f=function(x) ifelse(mai$nb_ventes_autre==0, NA, x)
mai=mai %>% mutate(across(.cols = 35, .fns=f))


mai$mais_sale = replace_na(mai$masse_unité_epis,0) * replace_na(mai$nb_ventes_epis,0) +
                 replace_na(mai$masse_unité_grains,0) * replace_na(mai$nb_ventes_grains,0) +
                replace_na(mai$masse_unité_gritz,0) * replace_na(mai$nb_ventes_gritz,0) +
                replace_na(mai$masse_unité_farine,0) * replace_na(mai$nb_ventes_farine,0)

mai$part_autoconso = as.numeric(sub("%", "", mai$part_autoconso))
mai$part_vendue = as.numeric(sub("%", "", mai$part_vendue))
mai$part_alim_animale = as.numeric(sub("%", "", mai$part_alim_animale))

mai$part_totale = mai$part_autoconso + mai$part_vendue + mai$part_alim_animale

mai$part_autoconso = ifelse(mai$part_totale > 100 | mai$part_totale < 100,
                            mai$part_autoconso * 100 / mai$part_totale, mai$part_autoconso)

mai$part_vendue = ifelse(mai$part_totale > 100 | mai$part_totale < 100,
                            mai$part_vendue * 100 / mai$part_totale, mai$part_vendue)

mai$part_alim_animale = ifelse(mai$part_totale > 100 | mai$part_totale < 100,
                         mai$part_alim_animale * 100 / mai$part_totale, mai$part_alim_animale)

mai$mais_production = 100 * mai$mais_sale / mai$part_vendue

mai$mais_production[is.na(mai$mais_production)] = 0

mai = mai[!is.na(mai$part_totale),]

mai = mai[ (mai$part_totale > 0),]

mai$mais_revenus = mai$prix_unité_epis * mai$nb_ventes_epis +
  mai$prix_unité_grains * mai$nb_ventes_grains +
  mai$prix_unité_gritz * mai$nb_ventes_gritz +
  mai$prix_unité_farine * mai$nb_ventes_farine

mai = merge(mai, man_mai_ara_saf_pla[, c(1, 3)], by = "id")

mai$rend_mais = ifelse(mai$surf_mais == 0, NA, mai$mais_production / mai$surf_mais)

# boxplot(mai$rend_mais)
mai$rend_mais = ifelse(mai$rend_mais > 12000, NA, mai$rend_mais)
# boxplot(mai$rend_mais)

# mean(na.omit(mai$rend_mais))

rdt_mais = mean(na.omit(mai$rend_mais))

# write.xlsx(mai, file = "Input_files\\6.4.2. Maïs.xlsx")

man_mai_ara_saf_pla = merge(man_mai_ara_saf_pla, mai[, c(1, 10)], by = "id", all.x = TRUE)

names(man_mai_ara_saf_pla)[9] = "part_vendue_mais"


# 6.4.3. Soja

soj = data[, c(732, 203:212, 214:242)]

names(soj) = c("id", "sem_autoprod", "sem_voisin", "sem_magasin", "sem_pepiniere", "sem_projet", "sem_prive", "sem_publique",
               "part_autoconso", "part_vendue", "part_alim_animale", "graines", "huile", "farine", "autre", "lait",
               "unité_vente_graines", "masse_unité_graines", "prix_unité_graines", "nb_ventes_graines",
               "unité_vente_huile", "masse_unité_huile", "prix_unité_huile", "nb_ventes_huile",
               "unité_vente_huile2", "masse_unité_huile2", "prix_unité_huile2", "nb_ventes_huile2",
               "unité_vente_farine", "masse_unité_farine", "prix_unité_farine", "nb_ventes_farine",
               "unité_vente_lait", "masse_unité_lait", "prix_unité_lait", "nb_ventes_lait",
               "unité_vente_autre", "masse_unité_autre", "prix_unité_autre", "nb_ventes_autre")
 

soj[, c(18:20, 22:24, 26:28, 30:32, 34:36, 38:40)][is.na(soj[, c(18:20, 22:24, 26:28, 30:32, 34:36, 38:40)])] = 0

soj[, c(18:20, 22:24, 26:28, 30:32, 34:36, 38:40)] = abs(soj[, c(18:20, 22:24, 26:28, 30:32, 34:36, 38:40)])

soj$soja_sale = replace_na(soj$masse_unité_graines,0) * replace_na(soj$nb_ventes_graines,0)+
  replace_na(soj$masse_unité_huile,0) * replace_na(soj$nb_ventes_huile,0) +
  replace_na(soj$masse_unité_huile2,0) * replace_na(soj$nb_ventes_huile2,0) +
  replace_na(soj$masse_unité_farine,0) * replace_na(soj$nb_ventes_farine,0) +
  replace_na(soj$masse_unité_lait,0) * replace_na(soj$nb_ventes_lait,0)

soj$part_autoconso = as.numeric(sub("%", "", soj$part_autoconso))
soj$part_vendue = as.numeric(sub("%", "", soj$part_vendue))
soj$part_alim_animale = as.numeric(sub("%", "", soj$part_alim_animale))

soj$part_totale = soj$part_autoconso + soj$part_vendue + soj$part_alim_animale

soj$part_autoconso = ifelse(soj$part_totale > 100 | soj$part_totale < 100,
                            soj$part_autoconso * 100 / soj$part_totale, soj$part_autoconso)

soj$part_vendue = ifelse(soj$part_totale > 100 | soj$part_totale < 100,
                         soj$part_vendue * 100 / soj$part_totale, soj$part_vendue)

soj$part_alim_animale = ifelse(soj$part_totale > 100 | soj$part_totale < 100,
                               soj$part_alim_animale * 100 / soj$part_totale, soj$part_alim_animale)

soj$soja_production = 100 * soj$soja_sale / soj$part_vendue

soj$soja_production[is.na(soj$soja_production)] = 0

soj = soj[!is.na(soj$part_totale),]

soj = soj[ (soj$part_totale > 0),]

soj$soja_revenus = soj$prix_unité_graines * soj$nb_ventes_graines +
  soj$prix_unité_huile * soj$nb_ventes_huile +
  soj$prix_unité_huile2 * soj$nb_ventes_huile2 +
  soj$prix_unité_farine * soj$nb_ventes_farine +
  soj$prix_unité_lait * soj$nb_ventes_lait

# write.xlsx(soj, file = "Input_files\\6.4.3. Soja.xlsx")


# 6.4.4. Arachide

ara = data[, c(732, 244:252, 254:278)]

names(ara) = c("id", "sem_autoprod", "sem_voisin", "sem_magasin", "sem_pepiniere", "sem_projet", "sem_prive", "sem_publique",
               "part_autoconso", "part_vendue", "coques", "decortiquees", "huile", "autre", "pate",
               "unité_vente_coques", "masse_unité_coques", "prix_unité_coques", "nb_ventes_coques",
               "unité_vente_decortiquees", "masse_unité_decortiquees", "prix_unité_decortiquees", "nb_ventes_decortiquees",
               "unité_vente_huile", "masse_unité_huile", "prix_unité_huile", "nb_ventes_huile",
               "unité_vente_pate", "masse_unité_pate", "prix_unité_pate", "nb_ventes_pate",
               "unité_vente_autre", "masse_unité_autre", "prix_unité_autre", "nb_ventes_autre")
               
ara[, c(17:19, 21:23, 25:27, 29:31, 33:35)][is.na(ara[, c(17:19, 21:23, 25:27, 29:31, 33:35)])] = 0

ara[, c(17:19, 21:23, 25:27, 29:31, 33:35)] = abs(ara[, c(17:19, 21:23, 25:27, 29:31, 33:35)])

# COQUES : Objectif: Pour chaque prix de vente, association d'une masse correspondante

# a. identification des outliers sur "masse_unité_coques" 
f=function(x) ifelse(ara$masse_unité_coques>=150, NA, x)
ara=ara %>% mutate(across(.cols = c(16:35), .fns=f))
ara$masse_unité_coques[ara$id==483] = 0.1

# b. identification des outliers sur "prix_unité_coques" 
ara$prix_unité_coques[ara$id==240] = 20000
f=function(x) ifelse(ara$prix_unité_coques>90000, NA, x)
ara=ara %>% mutate(across(.cols = c(16:35), .fns=f))

# c. identification des outliers sur "nombre_ventes_coques". On considère que toute la production >50t/ha résulte d'erreures de saisie
ara=left_join(ara,plot_sum %>% select(id, cultivated_area), by="id")
ara= ara %>% mutate(rdt_ara_coques=(masse_unité_coques*nb_ventes_coques)/cultivated_area)
f=function(x) ifelse(ara$rdt_ara_coques>3500, NA, x)
ara=ara %>% mutate(across(.cols = c(16:35,37), .fns=f))

# d. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(ara$nb_ventes_coques==0, 0, x)
ara=ara %>% mutate(across(.cols = c(17:19), .fns=f))
f=function(x) ifelse(ara$nb_ventes_coques==0, NA, x)
ara=ara %>% mutate(across(.cols = 16, .fns=f))

# e. On ajoute une colonne "Département" au tableau ara en fonction la jointure avec "id"
ara=left_join(ara,loc %>% select(id, departement), by="id")

rdt_coques_dpt= ara %>%
  group_by(departement, unité_vente_coques, prix_unité_coques) %>%
  summarise(masse_moyenne_coques=mean(masse_unité_coques[masse_unité_coques != 0], na.rm = TRUE)) 

rdt_coques_dpt= filter(rdt_coques_dpt, !is.na(masse_moyenne_coques) & masse_moyenne_coques != 0)

#f. Pour chaque combinaison departement*unité*prix, on associe la masse correspondante
ara <- ara %>%
  left_join(rdt_coques_dpt, by = c("departement", "unité_vente_coques", "prix_unité_coques")) %>%
  mutate(masse_unité_coques = ifelse(masse_unité_coques == 0, masse_moyenne_coques, masse_unité_coques)) %>%
  select(-masse_moyenne_coques)  

rdt_coques_price= ara %>%
  group_by(prix_unité_coques) %>%
  summarise(masse_moyenne_coques=mean(masse_unité_coques[masse_unité_coques != 0], na.rm = TRUE)) 

rdt_coques_dpt= filter(rdt_coques_dpt, !is.na(masse_moyenne_coques) & masse_moyenne_coques != 0)

ara$masse_unité_coques[ara$id==202]=32.102941
ara$masse_unité_coques[ara$id==188]=10.125000


# DECORTIQUEES : Objectif: Pour chaque prix de vente, association d'une masse correspondante

# a. identification des outliers sur "masse_unité_decortiquees" 
f=function(x) ifelse(ara$masse_unité_decortiquees>=100, NA, x)
ara=ara %>% mutate(across(.cols = c(20:23), .fns=f))

# b. identification des outliers sur "prix_unité_decortiquees" 
ara$prix_unité_decortiquees[ara$id==479] = 500
ara$prix_unité_decortiquees[ara$id==1254] = 2500

# c. identification des outliers sur "nombre_ventes_decortiquees". On considère que toute la production >50t/ha résulte d'erreures de saisie
ara= ara %>% mutate(rdt_ara_decortiquees=(masse_unité_decortiquees*nb_ventes_decortiquees)/cultivated_area)
f=function(x) ifelse(ara$rdt_ara_decortiquees>3500, NA, x)
ara=ara %>% mutate(across(.cols = c(16:35,37,39), .fns=f))

# d. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(ara$nb_ventes_decortiquees==0, 0, x)
ara=ara %>% mutate(across(.cols = c(21:23), .fns=f))
f=function(x) ifelse(ara$nb_ventes_decortiquees==0, NA, x)
ara=ara %>% mutate(across(.cols = 20, .fns=f))



ara$arachide_sale = 0.7 * replace_na(ara$masse_unité_coques,0) * replace_na(ara$nb_ventes_coques,0) +
  replace_na(ara$masse_unité_decortiquees,0) * replace_na(ara$nb_ventes_decortiquees,0) +
  2 * replace_na(ara$masse_unité_huile,0) * replace_na(ara$nb_ventes_huile,0) +
  replace_na(ara$masse_unité_pate,0) * replace_na(ara$nb_ventes_pate,0)

ara$part_autoconso = as.numeric(sub("%", "", ara$part_autoconso))
ara$part_vendue = as.numeric(sub("%", "", ara$part_vendue))

ara$part_totale = ara$part_autoconso + ara$part_vendue

ara$part_autoconso = ifelse(ara$part_totale > 100 | ara$part_totale < 100,
                            ara$part_autoconso * 100 / ara$part_totale, ara$part_autoconso)

ara$part_vendue = ifelse(ara$part_totale > 100 | ara$part_totale < 100,
                         ara$part_vendue * 100 / ara$part_totale, ara$part_vendue)

ara$arachide_production = 100 * ara$arachide_sale / ara$part_vendue

ara$arachide_production[is.na(ara$arachide_production)] = 0

ara = ara[!is.na(ara$part_totale),]

ara = ara[ (ara$part_totale > 0),]

ara$arachide_revenus = ara$prix_unité_coques * ara$nb_ventes_coques +
  ara$prix_unité_decortiquees * ara$nb_ventes_decortiquees +
  ara$prix_unité_huile * ara$nb_ventes_huile +
  ara$prix_unité_pate * ara$nb_ventes_pate

ara = merge(ara, man_mai_ara_saf_pla[, c(1, 4)], by = "id")

ara$rend_arachide = ifelse(ara$surf_arachide == 0, NA, ara$arachide_production / ara$surf_arachide)

# boxplot(ara$rend_arachide)
ara$rend_arachide = ifelse(ara$rend_arachide > 3800, NA, ara$rend_arachide)
# boxplot(ara$rend_arachide)

# mean(na.omit(ara$rend_arachide))

rdt_arachide = mean(na.omit(ara$rend_arachide))

# write.xlsx(ara, file = "Input_files\\6.4.4. Arachide.xlsx")

man_mai_ara_saf_pla = merge(man_mai_ara_saf_pla, ara[, c(1, 10)], by = "id", all.x = TRUE)

names(man_mai_ara_saf_pla)[10] = "part_vendue_arachide"


# 6.4.5. Safou

saf = data[, c(732, 280:294)]

names(saf) = c("id", "plant_autoprod", "plant_voisin", "plant_magasin", "plant_pepiniere", "plant_projet", "plant_prive", "plant_publique",
               "age_max", "age_min", "part_autoconso", "part_vendue", "unité_vente", "masse_unité", "prix_unité", "nb_ventes")

saf[, c(14:16)][is.na(saf[, c(14:16)])] = 0

saf[, c(14:16)] = abs(saf[, c(14:16)])

# UNITE : Objectif: Pour chaque prix de vente, association d'une masse correspondante

# a. identification des outliers sur "masse_unité" 
f=function(x) ifelse(saf$masse_unité>=150, NA, x)
saf=saf %>% mutate(across(.cols = c(13:16), .fns=f))

# b. identification des outliers sur "prix_unité_coques" 

# c. identification des outliers sur "prix_unité_coques" 
saf= saf %>% mutate(rdt_saf=(masse_unité*nb_ventes))
f=function(x) ifelse(saf$rdt_saf>100000, NA, x) #Production supérieure à 100t/an = incorrecte
saf=saf %>% mutate(across(.cols = c(13:17), .fns=f))

# d. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(saf$nb_ventes==0, 0, x)
saf=saf %>% mutate(across(.cols = c(14:16), .fns=f))
f=function(x) ifelse(saf$nb_ventes==0, NA, x)
saf=saf %>% mutate(across(.cols = 13, .fns=f))

# e. On ajoute une colonne "Département" au tableau saf en fonction la jointure avec "id"
saf=left_join(saf,loc %>% select(id, departement), by="id")

rdt_saf_dpt= saf %>%
  group_by(departement, unité_vente, prix_unité) %>%
  summarise(masse_moyenne=mean(masse_unité[masse_unité != 0], na.rm = TRUE)) 

rdt_saf_dpt= filter(rdt_saf_dpt, !is.na(masse_moyenne) & masse_moyenne != 0)

#f.Pour chaque combinaison departement*unité*prix, on associe la masse correspondante
saf <- saf %>%
  left_join(rdt_saf_dpt, by = c("departement", "unité_vente", "prix_unité")) %>%
  mutate(masse_unité = ifelse(masse_unité == 0, masse_moyenne, masse_unité)) %>%
  select(-masse_moyenne) 


rdt_saf_price= saf %>%
  group_by(prix_unité, departement) %>%
  summarise(masse_moyenne=mean(masse_unité[masse_unité != 0], na.rm = TRUE)) 

rdt_saf_price= filter(rdt_saf_price, !is.na(masse_moyenne) & masse_moyenne != 0)


saf$masse_unité[saf$id==740] = 50 #
saf$masse_unité[saf$id==8] = 26.7
saf$masse_unité[saf$id==7] = 12
saf$masse_unité[saf$id==9] = 12
saf$masse_unité[saf$id==463] = 25
saf$masse_unité[saf$id==993] = 20
saf$masse_unité[saf$id==952] = 36.25

saf$masse_unité[saf$id==458] = 15
saf$masse_unité[saf$id==6] = 10
saf$masse_unité[saf$id==434] = 30
saf$masse_unité[saf$id==1000] = 30
saf$masse_unité[saf$id==1244] = 20


saf$safou_sale = replace_na(saf$masse_unité,0) * replace_na(saf$nb_ventes,0)

saf$part_autoconso = as.numeric(sub("%", "", saf$part_autoconso))
saf$part_vendue = as.numeric(sub("%", "", saf$part_vendue))

saf$part_totale = saf$part_autoconso + saf$part_vendue

saf$part_autoconso = ifelse(saf$part_totale > 100 | saf$part_totale < 100,
                            saf$part_autoconso * 100 / saf$part_totale, saf$part_autoconso)

saf$part_vendue = ifelse(saf$part_totale > 100 | saf$part_totale < 100,
                         saf$part_vendue * 100 / saf$part_totale, saf$part_vendue)

saf$safou_production = 100 * saf$safou_sale / saf$part_vendue

saf$safou_production[is.na(saf$safou_production)] = 0

saf = saf[!is.na(saf$part_totale),]

saf = saf[ (saf$part_totale > 0),]

saf$safou_revenus = saf$prix_unité * saf$nb_ventes

# write.xlsx(saf, file = "Input_files\\6.4.5. Safou.xlsx")

# 6.4.6. Cacao

cac = data[, c(732, 296:308, 310:317)]

names(cac) = c("id", "plant_autoprod", "plant_voisin", "plant_magasin", "plant_pepiniere", "plant_projet", "plant_prive", "plant_publique",
               "age_max", "age_min", "nb_tailles", "volume_cacao", "prix_cacao", "lieu_vente_cacao", "vente_cacao_marche", "vente_cacao_artisan",
               "vente_cacao_grossiste", "vente_cacao_indistriel", "vente_cacao_entrepreneur", "vente_cacao_autre", "vente_cacao_autre_precisez",
               "vente_totale")

cac = cac[!is.na(cac$volume_cacao),]

cac[, c(12:13)][is.na(cac[, c(12:13)])] = 0

cac[, c(12:13)] = abs(cac[, c(12:13)])

cac$cacao_revenus = cac$prix_cacao * cac$volume_cacao

# write.xlsx(cac, file = "Input_files\\6.4.6. Cacao.xlsx")


# 6.4.7. Café

caf = data[, c(732, 319:330, 332:339)]

names(caf) = c("id", "plant_autoprod", "plant_voisin", "plant_magasin", "plant_pepiniere", "plant_projet", "plant_prive", "plant_publique",
               "age_max", "age_min", "volume_cafe", "prix_cafe", "lieu_vente_cafe", "vente_cafe_marche", "vente_cafe_artisan",
               "vente_cafe_grossiste", "vente_cafe_indistriel", "vente_cafe_entrepreneur", "vente_cafe_autre", "vente_cafe_autre_precisez",
               "vente_totale")

caf = caf[!is.na(caf$volume_cafe),]

caf[, c(11:12)][is.na(caf[, c(11:12)])] = 0

caf[, c(11:12)] = abs(caf[, c(11:12)])

caf$cafe_revenus = caf$prix_cafe * caf$volume_cafe

# write.xlsx(caf, file = "Input_files\\6.4.7. Café.xlsx")


# 6.4.8. Plantain

pla = data[, c(732, 340:345)]

names(pla) = c("id", "part_autoconso", "part_vendue", "unité_vente", "masse_unité", "prix_unité", "nb_ventes")

pla[, c(5:7)][is.na(pla[, c(5:7)])] = 0

pla[, c(5:7)] = abs(pla[, c(5:7)])

pla$masse_unité = ifelse(pla$unité_vente == "Régime", 15, pla$masse_unité)
pla$masse_unité = ifelse(pla$unité_vente == "Main de plantain", 2.5, pla$masse_unité)

# Plantain: Objectif: Pour chaque prix de vente, association d'une masse correspondante

# a. identification des outliers sur "prix_unité" 
f=function(x) ifelse(pla$prix_unité>14000, NA, x)
pla=pla %>% mutate(across(.cols = c(4:7), .fns=f))

# b. identification des outliers sur "nombre_ventes". On considère que toute la production >50t/ha résulte d'erreures de saisie
pla= pla %>% mutate(rdt_pla=(masse_unité*nb_ventes))
f=function(x) ifelse(pla$rdt_pla>50000, NA, x)
pla=pla %>% mutate(across(.cols = c(5:8), .fns=f))

#d. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(pla$nb_ventes==0, 0, x)
pla=pla %>% mutate(across(.cols = c(5:8), .fns=f))
f=function(x) ifelse(pla$nb_ventes==0, NA, x)
pla=pla %>% mutate(across(.cols = 4, .fns=f))

#e. On ajoute une colonne "Département" au tableau pla en fonction la jointure avec "id"
pla=left_join(pla,loc %>% select(id, departement), by="id")

rdt_pla_dpt= pla %>%
  group_by(departement, prix_unité) %>%
  summarise(masse_moyenne=mean(masse_unité[masse_unité != 0], na.rm = TRUE)) 

rdt_pla_dpt= filter(rdt_pla_dpt, !is.na(masse_moyenne) & masse_moyenne != 0)

# f.Pour chaque combinaison departement*unité*prix, on associe la masse correspondante
pla <- pla %>%
  left_join(rdt_pla_dpt, by = c("departement","prix_unité")) %>%
  mutate(masse_unité = ifelse(masse_unité == 0, masse_moyenne, masse_unité)) %>%
  select(-masse_moyenne) 


pla$plantain_sale = replace_na(pla$masse_unité,0) * replace_na(pla$nb_ventes,0)

pla$part_autoconso = as.numeric(sub("%", "", pla$part_autoconso))
pla$part_vendue = as.numeric(sub("%", "", pla$part_vendue))

pla$part_totale = pla$part_autoconso + pla$part_vendue

pla$part_autoconso = ifelse(pla$part_totale > 100 | pla$part_totale < 100,
                            pla$part_autoconso * 100 / pla$part_totale, pla$part_autoconso)

pla$part_vendue = ifelse(pla$part_totale > 100 | pla$part_totale < 100,
                         pla$part_vendue * 100 / pla$part_totale, pla$part_vendue)

pla$plantain_production = 100 * pla$plantain_sale / pla$part_vendue

pla$plantain_production[is.na(pla$plantain_production)] = 0

pla = pla[!is.na(pla$part_totale),]

pla = pla[ (pla$part_totale > 0),]

pla$plantain_revenus = pla$prix_unité * pla$nb_ventes

pla = merge(pla, man_mai_ara_saf_pla[, c(1, 6)], by = "id")

pla$rend_plantain = ifelse(pla$surf_plantain == 0, NA, pla$plantain_production / pla$surf_plantain)

# boxplot(pla$rend_plantain)
pla$rend_plantain = ifelse(pla$rend_plantain > 20000, NA, pla$rend_plantain)
# boxplot(pla$rend_plantain)

# mean(na.omit(pla$rend_plantain))

rdt_plantain = mean(na.omit(pla$rend_plantain))

# write.xlsx(pla, file = "Input_files\\6.4.8. Plantain.xlsx")

man_mai_ara_saf_pla = merge(man_mai_ara_saf_pla, pla[, c(1, 3)], by = "id", all.x = TRUE)
names(man_mai_ara_saf_pla)[11] = "part_vendue_plantain"


# 6.4.9. Palmier

pal = data[, c(732, 347:357, 359:375)]

names(pal) = c("id", "plant_autoprod", "plant_voisin", "plant_magasin", "plant_pepiniere", "plant_projet", "plant_prive", "plant_publique",
               "age_max", "age_min", "part_autoconso", "part_vendue", "noix", "huile", "autre",
               "unité_vente_noix", "masse_unité_noix", "prix_unité_noix", "nb_ventes_noix",
               "unité_vente_huile", "masse_unité_huile", "prix_unité_huile", "nb_ventes_huile",
               "unité_vente_autre", "masse_unité_autre", "prix_unité_autre", "nb_ventes_autre",
               "presse", "status_presse")

pal[, c(17:19, 21:23, 25:27)][is.na(pal[, c(17:19, 21:23, 25:27)])] = 0

pal[, c(17:19, 21:23, 25:27)] = abs(pal[, c(17:19, 21:23, 25:27)])

# NOIX : Objectif: Pour chaque prix de vente, association d'une masse correspondante

#Ba. identification des outliers sur "masse_unité_noix" 
f=function(x) ifelse(pal$masse_unité_noix>300, NA, x)
pal=pal %>% mutate(across(.cols = c(17:27), .fns=f))

# b. identification des outliers sur "prix_unité_noix" 

# c. identification des outliers sur "nombre_ventes_noix". On considère que toute la production >50t/ha résulte d'erreures de saisie
pal=left_join(pal,plot_sum %>% select(id, cultivated_area), by="id")
pal= pal %>% mutate(rdt_pal_noix=(masse_unité_noix*nb_ventes_noix)/cultivated_area)
f=function(x) ifelse(pal$rdt_pal_noix>50000, NA, x)
pal=pal %>% mutate(across(.cols = c(16:27,31), .fns=f))

# d. Si ventes=0, alors "masse" et "prix" =0
f=function(x) ifelse(pal$nb_ventes_noix==0, 0, x)
pal=pal %>% mutate(across(.cols = c(17:19), .fns=f))
f=function(x) ifelse(pal$nb_ventes_noix==0, NA, x)
pal=pal %>% mutate(across(.cols = 16, .fns=f))

pal$masse_unité_noix[pal$id==1024] = 0.1

# HUILE et AUTRE : Pas de nettoyage à faire

pal$palmier_sale = replace_na(pal$masse_unité_noix,0) * replace_na(pal$nb_ventes_noix,0) +
  replace_na(pal$masse_unité_huile,0) * replace_na(pal$nb_ventes_huile,0)

pal$part_autoconso = as.numeric(sub("%", "", pal$part_autoconso))
pal$part_vendue = as.numeric(sub("%", "", pal$part_vendue))

pal$part_totale = pal$part_autoconso + pal$part_vendue

pal$part_autoconso = ifelse(pal$part_totale > 100 | pal$part_totale < 100,
                            pal$part_autoconso * 100 / pal$part_totale, pal$part_autoconso)

pal$part_vendue = ifelse(pal$part_totale > 100 | pal$part_totale < 100,
                         pal$part_vendue * 100 / pal$part_totale, ara$part_vendue)

pal$palmier_production = 100 * pal$palmier_sale / pal$part_vendue

pal$palmier_production[is.na(pal$palmier_production)] = 0

pal = pal[!is.na(pal$part_totale),]

pal = pal[ (pal$part_totale > 0),]

pal$palmier_revenus = pal$prix_unité_noix * pal$nb_ventes_noix +
  pal$prix_unité_huile * pal$nb_ventes_huile

# write.xlsx(pal, file = "Input_files\\6.4.9. Palmier.xlsx")


# 6.5. Orientation

# rdt_manioc
# rdt_mais
# rdt_arachide
# rdt_plantain

man_mai_ara_saf_pla$prod_totale = rdt_manioc * man_mai_ara_saf_pla$surf_manioc +
  rdt_mais * man_mai_ara_saf_pla$surf_mais +
  rdt_arachide * man_mai_ara_saf_pla$surf_arachide +
  rdt_plantain * man_mai_ara_saf_pla$surf_plantain

man_mai_ara_saf_pla$part_vendue_manioc[is.na(man_mai_ara_saf_pla$part_vendue_manioc)] = 0
man_mai_ara_saf_pla$part_vendue_mais[is.na(man_mai_ara_saf_pla$part_vendue_mais)] = 0
man_mai_ara_saf_pla$part_vendue_arachide[is.na(man_mai_ara_saf_pla$part_vendue_arachide)] = 0
man_mai_ara_saf_pla$part_vendue_plantain[is.na(man_mai_ara_saf_pla$part_vendue_plantain)] = 0

man_mai_ara_saf_pla$prod_totale_vendue = rdt_manioc * man_mai_ara_saf_pla$surf_manioc * man_mai_ara_saf_pla$part_vendue_manioc / 100 +
  rdt_mais * man_mai_ara_saf_pla$surf_mais * man_mai_ara_saf_pla$part_vendue_mais / 100 +
  rdt_arachide * man_mai_ara_saf_pla$surf_arachide * man_mai_ara_saf_pla$part_vendue_arachide / 100 +
  rdt_plantain * man_mai_ara_saf_pla$surf_plantain * man_mai_ara_saf_pla$part_vendue_plantain / 100

man_mai_ara_saf_pla$prop_vente = man_mai_ara_saf_pla$prod_totale_vendue * 100 / man_mai_ara_saf_pla$prod_totale

man_mai_ara_saf_pla$prop_vente[is.na(man_mai_ara_saf_pla$prop_vente)] = 0

# hist(man_mai_ara_saf_pla$prop_vente)
# quantile(na.omit(man_mai_ara_saf_pla$prop_vente), c(.33, .67)) 

# man_mai_ara_saf_pla$orientation = ifelse(man_mai_ara_saf_pla$prop_vente < 33, 1,
#                                          ifelse(man_mai_ara_saf_pla$prop_vente > 67, 3, 2))

man_mai_ara_saf_pla$orientation = ifelse(man_mai_ara_saf_pla$prop_vente > 50, 1, 0)

# write.xlsx(man_mai_ara_saf_pla, file = "Input_files\\6.5. Orientation.xlsx")

 
# 6.6. Précédent

prec = plot[, c(1, 33, 36)]

prec = prec %>% 
  group_by(id) %>% 
  slice_max(plot_surface, n = 1) %>%
  ungroup()

prec = unique(prec)

prec$previous_vegetation = ifelse(prec$previous_vegetation == "Savane herbacée", 1,
                                  ifelse(prec$previous_vegetation == "Savane arbustive", 2,
                                         ifelse(prec$previous_vegetation == "Forêt dégradée", 3, 4)))

prec = aggregate(. ~ id, FUN = mean, na.rm = TRUE, data = prec[, c(1, 3)])

prec$previous_vegetation = trunc(prec$previous_vegetation)

prec$previous_vegetation = ifelse(prec$previous_vegetation == 1,"Savane herbacée",
                                  ifelse(prec$previous_vegetation == 2, "Savane arbustive", 
                                         ifelse(prec$previous_vegetation == 3, "Forêt dégradée", "Forêt dense / jamais mise en culture")))


jac = plot[, c(1, 33:35)]

jac = jac %>% 
  group_by(id) %>% 
  slice_max(plot_surface, n = 1) %>%
  ungroup()

jac = unique(jac)

jac$fallow_duration = ifelse(jac$fallow_duration == "1-2 ans", 1,
                             ifelse(jac$fallow_duration == "3-5 ans", 2,
                                    ifelse(jac$fallow_duration == "6-8 ans", 3,
                                           ifelse(jac$fallow_duration == "9-11 ans", 4,
                                                  ifelse(jac$fallow_duration == "12-15 ans", 5,
                                                         ifelse(jac$fallow_duration == "15 ans et +", 6, 7))))))


jac$fallow_duration = ifelse(jac$previous_fallow == "0", 7, jac$fallow_duration)


jac = aggregate(. ~ id, FUN = mean, na.rm = TRUE, data = jac[, c(1, 4)])

jac$fallow_duration = trunc(jac$fallow_duration)

jac$fallow_duration = ifelse(jac$fallow_duration == "1", "1-2 ans", 
                             ifelse(jac$fallow_duration == "2", "3-5 ans", 
                                    ifelse(jac$fallow_duration == "3", "6-8 ans", 
                                           ifelse(jac$fallow_duration == "4", "9-11 ans", 
                                                  ifelse(jac$fallow_duration == "5", "12-15 ans", 
                                                         ifelse(jac$fallow_duration == "6", "15 ans et +",  
                                                                "Pas de jachère"))))))

# table(jac$fallow_duration)

jac$fallow_duration_simplifie = ifelse(jac$fallow_duration == "1-2 ans" | jac$fallow_duration == "3-5 ans", "1-5 ans",
                                       ifelse(jac$fallow_duration == "6-8 ans" | jac$fallow_duration == "9-11 ans", "6-11 ans",
                                              ifelse(jac$fallow_duration == "12-15 ans" | jac$fallow_duration == "15 ans et +", "12 ans et +", "Pas de jachère")))



# table(plot$statut_champ)

sta = plot[, c(1, 33, 39)]

sta = sta %>% 
  group_by(id) %>% 
  slice_max(plot_surface, n = 1) %>%
  ungroup()

sta = unique(sta)

sta$statut_champ = ifelse(sta$statut_champ == "Propriété", 1,
                                  ifelse(sta$statut_champ == "Autre", 2, 3))

sta = aggregate(. ~ id, FUN = mean, na.rm = TRUE, data = sta[, c(1, 3)])

sta$statut_champ = trunc(sta$statut_champ)

sta$statut_champ = ifelse(sta$statut_champ == 1,"Propriété",
                                  ifelse(sta$statut_champ == 2, "Autre", "Location "))

prec = merge(prec, jac, by = "id")

prec = merge(prec, sta, by = "id")

# write.xlsx(prec, file = "Input_files\\6.6. Précédent et status.xlsx")


# 6.7. Elevage

# 6.7.1. Bétail

bet = data[, c(732, 387:423)]

names(bet)[1] = "id"
names(bet)[2] = "bovins_adu"
names(bet)[3] = "bovins_juv"
names(bet)[10] = "porcs"
names(bet)[17] = "moutons_adu"
names(bet)[18] = "moutons_juv"
names(bet)[25] = "chevres_adu"
names(bet)[26] = "chevres_juv"
names(bet)[33] = "volailles"

# Cleaning des cheptels incorrects 
bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcs_achetes[bet$id==474]=3
bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_vente_de_porcs [bet$id==30]=75
bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_moutons_achetes [bet$id==474]=2

bet$bovins_adu[is.na(bet$bovins_adu)] = 0
bet$bovins_juv[is.na(bet$bovins_juv)] = 0
bet$porcs[is.na(bet$porcs)] = 0
bet$moutons_adu[is.na(bet$moutons_adu)] = 0
bet$moutons_juv[is.na(bet$moutons_juv)] = 0
bet$chevres_adu[is.na(bet$chevres_adu)] = 0
bet$chevres_juv[is.na(bet$chevres_juv)] = 0
bet$volailles[is.na(bet$volailles)] = 0

bet$bovins = bet$bovins_adu + bet$bovins_juv
bet$petits_ruminants = bet$moutons_adu + bet$moutons_juv + bet$chevres_adu + bet$chevres_juv
bet$ubt = 0.7 * (bet$bovins_adu + bet$bovins_juv) + 0.2 * bet$porcs +
  0.1 * (bet$moutons_adu + bet$moutons_juv + bet$chevres_adu + bet$chevres_juv) +
  0.01 * bet$volailles

bet[, c(2:3, 5:10, 12:18, 20:26, 28:33, 36:38)][is.na(bet[, c(2:3, 5:10, 12:18, 20:26, 28:33, 36:38)])] = 0

bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_vente_de_porcs = ifelse(bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_vente_de_porcs == "750000", 75, bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_vente_de_porcs)

bet$betail_consomation = 0.7 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_abattues_pour_votre_consommation_390 +
  0.2 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcs_abattus_pour_votre_consommation +
  0.1 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_abattues_pour_votre_consommation_405 +
  0.1 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_abattues_pour_votre_consommation_413 +
  0.01 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_volailles_consommees_par_le_menage

bet$betail_ventes = 0.7 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_ventes_394 +
  0.2 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_vente_de_porcs +
  0.1 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_ventes_409 +
  0.1 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_ventes_417 +
  0.01 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_volailles_vendues

bet$betail_mortalite = 0.7 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_predateurs +
  0.2 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcs_morts_en_raison_de_maladies +
  0.1 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_406 +
  0.1 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_414

bet$betail_croit = 0.7 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_velage +
  0.7 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_bovins_achetees +
  0.2 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcelets_produits +
  0.2 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcs_achetes +
  0.1 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_mise_bas +
  0.1 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_moutons_achetes +
  0.1 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_chevreaux_nes +
  0.1 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_chevres_achetees

bet$betail_productivite = bet$betail_consomation + bet$betail_ventes

bet$betail_taux_prelevement = 100 * bet$betail_productivite / (bet$ubt + bet$betail_productivite + bet$betail_mortalite - bet$betail_croit)

bet$betail_taux_mortalite = 100 * bet$betail_mortalite / (bet$ubt + bet$betail_productivite + bet$betail_mortalite - bet$betail_croit)

bet$bovin_productivite = bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_abattues_pour_votre_consommation_390 +
  bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_bovins_achetees

bet$porcs_productivite = bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcs_abattus_pour_votre_consommation +
  bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_vente_de_porcs

bet$petits_ruminants_productivite = bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_abattues_pour_votre_consommation_405 +
  bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_ventes_409 +
  bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_abattues_pour_votre_consommation_413 +
  bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_chevres_achetees

bet$volailles_productivite = bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_volailles_vendues +
  bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_volailles_consommees_par_le_menage

bet$bovin_taux_prelevement = 100 * bet$bovin_productivite / (bet$bovins + bet$bovin_productivite + bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_predateurs - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_velage - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_bovins_achetees)

bet$porcs_taux_prelevement = 100 * bet$porcs_productivite / (bet$porcs + bet$porcs_productivite + bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcs_morts_en_raison_de_maladies - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcelets_produits - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcs_achetes)

bet$petits_ruminants_taux_prelevement = 100 * bet$petits_ruminants_productivite / (bet$petits_ruminants + bet$petits_ruminants_productivite + bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_406 - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_mise_bas - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_moutons_achetes + bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_414 - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_chevreaux_nes - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_chevres_achetees)

bet$volailles_taux_prelevement = 100 * bet$volailles_productivite / (bet$volailles + bet$volailles_productivite)

bet$oeuf_productivite = bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_doeufs_vendus / bet$volailles

bet$bovin_taux_mortalite = 100 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_predateurs / (bet$bovins + bet$bovin_productivite + bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_predateurs - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_velage - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_bovins_achetees)

bet$porcs_taux_mortalite = 100 * bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcs_morts_en_raison_de_maladies / (bet$porcs + bet$porcs_productivite + bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcs_morts_en_raison_de_maladies - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcelets_produits - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_porcs_achetes)

bet$petits_ruminants_mortalite = 100 * (bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_406 + bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_414) / (bet$petits_ruminants + bet$petits_ruminants_productivite + bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_406 - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_mise_bas - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_moutons_achetes + bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_betes_mortes_en_raison_de_maladies_414 - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_chevreaux_nes - bet$sur_les_12_derniers_mois_a_combien_estimez_vous_le_nombre_de_chevres_achetees)

bet = bet[, c(1, 39, 10, 40, 33, 41:52, 38, 53:60, 4, 11, 19, 27, 35)]

names(bet)[c(18, 27:31)] = c("oeufs", "alim_appoint_bovins", "alim_appoint_porcs", "alim_appoint_moutons", "alim_appoint_chevres", "alim_appoint_volailles")

bet$alim_appoint_bovins = ifelse(bet$alim_appoint_bovins == "Oui", 1, 0)
bet$alim_appoint_porcs = ifelse(bet$alim_appoint_porcs == "Oui", 1, 0)
bet$alim_appoint_moutons = ifelse(bet$alim_appoint_moutons == "Oui", 1, 0)
bet$alim_appoint_chevres = ifelse(bet$alim_appoint_chevres == "Oui", 1, 0)
bet$alim_appoint_volailles = ifelse(bet$alim_appoint_volailles == "Oui", 1, 0)

bet$alim_appoint_petits_ruminants = bet$alim_appoint_moutons + bet$alim_appoint_chevres
bet$alim_appoint_petits_ruminants = ifelse(bet$alim_appoint_moutons > 0, 1, 0)

bet = bet[, c(1:28, 32, 31)]

# write.xlsx(bet, file = "Input_files\\6.7.1. Production bétail.xlsx")


# 6.7.2. Poissons

pois = data[, c(732, 424, 426:433)]

names(pois)[c(1:10)] = c("id", "nb_etangs", "tilapia", "silure", "machoiron",
                              "malangwa", "autre_poisson", "alim_appoint_poissons",
                              "poisson_consommation", "poisson_ventes")

pois$nb_etangs[is.na(pois$nb_etangs)] = 0

pois$alim_appoint_poissons = ifelse(pois$alim_appoint_poissons == "Oui", 1, 0)

pois$poisson_consommation[is.na(pois$poisson_consommation)] = 0
pois$poisson_ventes[is.na(pois$poisson_ventes)] = 0

# write.xlsx(pois, file = "Input_files\\6.7.2. Production poissons.xlsx")


# 6.8. Utilisation des ressources naturelles

res = data[, c(732, 434:462)]

names(res)[c(1:2, 4, 6, 18:28)] = c("id", "chasse", "peche", "charbon", "miel", "fruits", "feuilles",
                              "asperges", "rotins", "ecorces", "poivre", "seve", "noix",
                              "chenilles", "champignons")

res$chasse = as.numeric(res$chasse == "Oui")
res$peche = as.numeric(res$peche == "Oui")
res$charbon = as.numeric(res$charbon == "Oui")
res$miel[is.na(res$miel)] = 0
res$fruits[is.na(res$fruits)] = 0
res$feuilles[is.na(res$feuilles)] = 0
res$asperges[is.na(res$asperges)] = 0
res$rotins[is.na(res$rotins)] = 0
res$ecorces[is.na(res$ecorces)] = 0
res$poivre[is.na(res$poivre)] = 0
res$seve[is.na(res$seve)] = 0
res$noix[is.na(res$noix)] = 0
res$chenilles[is.na(res$chenilles)] = 0
res$champignons[is.na(res$champignons)] = 0

# Nettoyage variables sur la production du charbon

res$pouvez_vous_estimer_le_poids_dun_sac_kg[res$combien_de_sacs_ont_ete_produit_sur_les_12_derniers_mois ==  0 ] =  NA
res$a_quel_prix_vendez_vous_un_sac_fcfa[res$combien_de_sacs_ont_ete_produit_sur_les_12_derniers_mois ==  0 ] =  NA
res$combien_de_sacs_ont_ete_produit_sur_les_12_derniers_mois[res$combien_de_sacs_ont_ete_produit_sur_les_12_derniers_mois ==  0 ] =  NA
res$a_quel_prix_vendez_vous_un_sac_fcfa[res$a_quel_prix_vendez_vous_un_sac_fcfa ==  5 ] =  NA
res$a_quel_prix_vendez_vous_un_sac_fcfa[res$a_quel_prix_vendez_vous_un_sac_fcfa ==  0 ] =  NA


# Nettoyage cueillettes : Autres 

res$feuilles[res$precisez_462 %in% c("Amaranthe sauvage", "Ngetum", "Fougere")] = 1
res$precisez_462[res$precisez_462 %in% c("Amaranthe sauvage", "Ngetum", "Fougere")] = NA
res$seve[res$precisez_462 == "Vin de palme"] = 1
res$precisez_462[res$precisez_462 == "Vin de palme"] = NA
res$precisez_462[res$precisez_462 %in% c("Oseille sauvage", "Asperges, champignon", "RAS", "Rien", "Tina")] = NA


res$nb_pfnl = res$chasse + res$peche + res$miel + res$fruits + res$feuilles + res$asperges +
  res$rotins + res$ecorces + res$poivre + res$seve + res$noix + res$chenilles + res$champignons

# write.xlsx(res, file = "Input_files\\6.8. Ressources naturelles.xlsx")


# 7. Revenus--------------------------------------------------------------------

# 7.1. Revenus principaux

rev_princ = data[, c(732, 465:467)]

names(rev_princ) = c("id", "source_rev_1", "source_rev_2", "source_rev_3")

# write.xlsx(rev_princ, file = "Input_files\\7.1. Revenus principaux.xlsx")


# 7.2. Revenus totaux

# Revenus agricole
# Pour identifier les revenus trop conséquents, on se base sur les VA identifiés avec le ration revenu agricole/ha

# Calcul du revenu agricole
calcul_revenu_agricole = function(men) {
  # Initialiser une colonne pour stocker les revenus agricoles
  men$revenu_agricole = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu agricole à 0 pour l'individu courant
    revenu_agricole = 0
    # Associer les revenus si l'activité est "Agriculteur/rice"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Agriculteur/rice") {
      revenu_agricole = revenu_agricole + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Agriculteur/rice") {
      revenu_agricole = revenu_agricole + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Agriculteur/rice") {
      revenu_agricole = revenu_agricole + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus agricoles 
    men$revenu_agricole[i] = revenu_agricole
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenus agricoles
  return(men)
}
men = calcul_revenu_agricole(men)

# calcul du revenu agricole rapporté à 1ha
rend_agr = aggregate (revenu_agricole ~ id, FUN =sum, na.rm=FALSE, data=men)
rend_agr = inner_join(rend_agr,plot_sum, by="id", copy = FALSE)
rend_agr= rend_agr[, c(1,2,35)]
rend_agr= rend_agr %>% mutate(revenu_agri_ha=revenu_agricole/cultivated_area) #revenu agricole rapporté à 1ha

rend1=filter(rend_agr, revenu_agri_ha!=0)
# boxplot(rend1$revenu_agri_ha, ylim = c(0, 2000000))
outlier_rend1 = boxplot.stats(rend1$revenu_agri_ha)$out
# outlier_rend1 
outlier_idx_rend1 = which(rend1$revenu_agri_ha %in% c(outlier_rend1))
# Pour ces individus, statistiques, je propose de mettre des NA pour toutes les valeurs liées au chiffrage des activités agricoles
df_outliers = rend1[outlier_idx_rend1, ]
df_outliers = filter(df_outliers, revenu_agri_ha != "Inf" )
# Donc pour tous les id. de df_outliers, on va mettre des NA pour l'ensemble des revenus et ne pas calculer le revenu total. 
# Et cela pour tous les membres de la famille
men$revenus_1[men$id %in% df_outliers$id] = NA
men$revenus_2[men$id %in% df_outliers$id] = NA
men$revenus_3[men$id %in% df_outliers$id] = NA
men$revenus_totaux[men$id %in% df_outliers$id] = NA
men$revenu_agricole[men$id %in% df_outliers$id] = NA

# men$revenus_totaux = men$revenus_1 +
#   men$revenus_2 +
#   men$revenus_3

# Revenu Elevage
# Calcul du revenu lié à l'élevage
calcul_revenu_elevage = function(men) {
  # Initialiser une colonne pour stocker les revenus elevage
  men$revenu_elevage = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu elevage à 0 pour l'individu courant
    revenu_elevage = 0
    # Associer les revenus si l'activité est "Agriculteur/rice"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Elevage") {
      revenu_elevage = revenu_elevage + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Elevage") {
      revenu_elevage = revenu_elevage + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Elevage") {
      revenu_elevage = revenu_elevage + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus elevages 
    men$revenu_elevage[i] = revenu_elevage
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu charbon
  return(men)
}
men = calcul_revenu_elevage(men)

#bb) On identifie les Outliers de trois façons différentes:
  # b' : Outliers sur les valeurs absolues du revenu élevage
  # b'' :Outliers sur revenu elevage / UBT
  # b''' : Outliers sur revenu elevage / UBT vendu 
  
  #b' :
  # Après mise en relation des revenus_elevage avec les informations données dans la bdd "liv".
  # Seules les deux valeurs les plus extremes semblent etre incohérentes (mb_id = 3683 et mb_id=1317)
  men$revenus_1[men$mb_id == 3683] = NA
  men$revenus_2[men$mb_id == 3683] = NA
  men$revenus_3[men$mb_id == 3683] = NA
  men$revenus_totaux[men$mb_id == 3683] = NA
  men$revenu_agricole[men$mb_id == 3683] = NA
  men$revenu_elevage[men$mb_id == 3683] = NA
  
  men$revenus_1[men$mb_id == 1317] = NA
  men$revenus_2[men$mb_id == 1317] = NA
  men$revenus_3[men$mb_id == 1317] = NA
  men$revenus_totaux[men$mb_id == 1317] = NA
  men$revenu_agricole[men$mb_id == 1317] = NA
  men$revenu_elevage[men$mb_id == 1317] = NA
  
# b. Calcul du revenu lié à l'élevage rapporté au nombre d'UBT vendus
  rend_bet = aggregate (revenu_elevage ~ id, FUN =sum, na.rm=FALSE, data=men)
  
  rend_bet = inner_join(rend_bet,bet, by="id", copy = FALSE)
  rend_bet= rend_bet[, c(1,2,9)]
  rend_bet= rend_bet %>% mutate(revenu_elev_1UBT=revenu_elevage/betail_ventes) #revenu elevage rapporté à 1 UBT vendu
  
  rend2=filter(rend_bet, revenu_elev_1UBT!=0)
  # boxplot(rend2$revenu_elev_1UBT, ylim = c(0, 15000000))
  outlier_rend2 = boxplot.stats(rend2$revenu_elev_1UBT)$out
  # outlier_rend2 
  outlier_idx_rend2 = which(rend2$revenu_elev_1UBT %in% c(outlier_rend2))
  
  df_outliers2 = rend2[outlier_idx_rend2, ]
  df_outliers2 = filter(df_outliers2, revenu_elev_1UBT != "Inf" )
  # On supprime les outliers
  men$revenus_1[men$id %in% df_outliers2$id] = NA
  men$revenus_2[men$id %in% df_outliers2$id] = NA
  men$revenus_3[men$id %in% df_outliers2$id] = NA
  men$revenus_totaux[men$id %in% df_outliers2$id] = NA
  men$revenu_agricole[men$id %in% df_outliers2$id] = NA
  men$revenu_elevage[men$id %in% df_outliers2$id] = NA
  
  # b. Calcul du revenu lié à l'élevage rapporté au nombre total d'UBT 
  rend_bet = inner_join(rend_bet,bet, by="id", copy = FALSE)
  rend_bet= rend_bet[, c(1:4,9)]
  rend_bet= rend_bet %>% mutate(revenu_elev_TOTUBT=revenu_elevage/ubt) #revenu elevage rapporté à 1 UBT 
  
  rend2=filter(rend_bet, revenu_elev_TOTUBT!=0)
  # boxplot(rend2$revenu_elev_TOTUBT, ylim = c(0, 15000000))
  outlier_rend3 = boxplot.stats(rend2$revenu_elev_TOTUBT)$out
  # outlier_rend3 
  outlier_idx_rend3 = which(rend2$revenu_elev_TOTUBT %in% c(outlier_rend3))
  
  df_outliers3 = rend2[outlier_idx_rend3, ]
  df_outliers3 = filter(df_outliers3, revenu_elev_TOTUBT != "Inf" )
  # On supprime les outliers
  men$revenus_1[men$id %in% df_outliers3$id] = NA
  men$revenus_2[men$id %in% df_outliers3$id] = NA
  men$revenus_3[men$id %in% df_outliers3$id] = NA
  men$revenus_totaux[men$id %in% df_outliers3$id] = NA
  men$revenu_agricole[men$id %in% df_outliers3$id] = NA
  men$revenu_elevage[men$id %in% df_outliers3$id] = NA
  

# 7.2.3 Revenu charbon
 # Calcul du revenu déclaré lié à la production de charbon
  calcul_revenu_charbon = function(men) {
    # Initialiser une colonne pour stocker les revenus charbon
    men$revenu_charbon = 0
    # Parcourir les individus (lignes) du tableau
    for (i in 1:nrow(men)) {
      # Initialiser le revenu charbon à 0 pour l'individu courant
      revenu_charbon = 0
      # Associer les revenus si l'activité est "Charbon ou bois de chauffe"
      if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Charbon ou bois de chauffe") {
        revenu_charbon = revenu_charbon + men$revenus_1[i]
      }
      if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Charbon ou bois de chauffe") {
        revenu_charbon = revenu_charbon + men$revenus_2[i]
      }
      if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Charbon ou bois de chauffe") {
        revenu_charbon = revenu_charbon + men$revenus_3[i]
      }
      # Mettre à jour la colonne des revenus charbon 
      men$revenu_charbon[i] = revenu_charbon
    }
    
    # Retourner le tableau de données avec la nouvelle colonne de revenu charbon
    return(men)
  }
  men = calcul_revenu_charbon(men)
  
  # Calcul du revenu charbon calculé (nb sacs*poids du sac)
  res=res %>% mutate(revenu_charbon_calc=combien_de_sacs_ont_ete_produit_sur_les_12_derniers_mois*a_quel_prix_vendez_vous_un_sac_fcfa)
  rend_char=res[,c(1,32)]
  rend_char= rend_char %>% mutate(revenu_charbon_calc = replace(revenu_charbon_calc, is.na(revenu_charbon_calc), 0))

# 7.2.4 Revenu Pêche

# Calcul du revenu lié à la pêche
calcul_revenu_peche = function(men) {
  # Initialiser une colonne pour stocker les revenus peche
  men$revenu_peche = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu peche à 0 pour l'individu courant
    revenu_peche = 0
    # Associer les revenus si l'activité est "peche"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Pêche") {
      revenu_peche = revenu_peche + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Pêche") {
      revenu_peche = revenu_peche + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Pêche") {
      revenu_peche = revenu_peche + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus peches 
    men$revenu_peche[i] = revenu_peche
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu peche
  return(men)
}
men = calcul_revenu_peche(men)
rend_peche = aggregate (revenu_peche ~ id, FUN =sum, na.rm=F, data=men)
peche_out=filter(rend_peche, revenu_peche!=0)
# On identifie les outliers
# boxplot(peche_out$revenu_peche)
outlier_peche1 = boxplot.stats(peche_out$revenu_peche)$out
# outlier_peche1 
outlier_idx_peche1 = which(peche_out$revenu_peche %in% c(outlier_peche1)) 
# outlier_idx_peche1
# On identifie 12 outliers. Après vérification avec les enquêteurs, seules la valeur de id=1225 est incorrecte
rend_peche$revenu_peche[rend_peche$id == 1225] = 386000


# 7.2.5 Revenu Pisciculture

calcul_revenu_pisciculture = function(men) {
  # Initialiser une colonne pour stocker les revenus pisciculture
  men$revenu_pisciculture = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu pisciculture à 0 pour l'individu courant
    revenu_pisciculture = 0
    # Associer les revenus si l'activité est "pisciculture"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Pisciculture") {
      revenu_pisciculture = revenu_pisciculture + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Pisciculture") {
      revenu_pisciculture = revenu_pisciculture + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Pisciculture") {
      revenu_pisciculture = revenu_pisciculture + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus piscicultures 
    men$revenu_pisciculture[i] = revenu_pisciculture
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu peche
  return(men)
}
men = calcul_revenu_pisciculture(men)
rend_pisciculture = aggregate (revenu_pisciculture ~ id, FUN =sum, na.rm=FALSE, data=men)
#Pas besoin d'enlever des outliers

# 7.2.6 Revenu Ouvrier

calcul_revenu_ouvrier = function(men) {
  # Initialiser une colonne pour stocker les revenus ouvrier
  men$revenu_ouvrier = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu ouvrier à 0 pour l'individu courant
    revenu_ouvrier = 0
    # Associer les revenus si l'activité est "ouvrier"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Ouvrier ou machiniste à l'extérieur") {
      revenu_ouvrier = revenu_ouvrier + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Ouvrier ou machiniste à l'extérieur") {
      revenu_ouvrier = revenu_ouvrier + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Ouvrier ou machiniste à l'extérieur") {
      revenu_ouvrier = revenu_ouvrier + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus Ouvrier
    men$revenu_ouvrier[i] = revenu_ouvrier
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu ouvrier
  return(men)
}
men = calcul_revenu_ouvrier(men)
rend_ouvrier = aggregate (revenu_ouvrier ~ id, FUN =sum, na.rm=FALSE, data=men)


# 7.2.7 Revenu Orpaillage

calcul_revenu_orpaillage = function(men) {
  # Initialiser une colonne pour stocker les revenus orpaillage
  men$revenu_orpaillage = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu orpaillage à 0 pour l'individu courant
    revenu_orpaillage = 0
    # Associer les revenus si l'activité est "orpaillage"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Orpaillage") {
      revenu_orpaillage = revenu_orpaillage + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Orpaillage") {
      revenu_orpaillage = revenu_orpaillage + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Orpaillage") {
      revenu_orpaillage = revenu_orpaillage + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus orpaillage
    men$revenu_orpaillage[i] = revenu_orpaillage
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu orpaillage
  return(men)
}
men = calcul_revenu_orpaillage(men)
rend_orpaillage = aggregate (revenu_orpaillage ~ id, FUN =sum, na.rm=FALSE, data=men)


# 7.2.8 Revenu Exploitation forestière

calcul_revenu_exploitation_forestiere = function(men) {
  # Initialiser une colonne pour stocker les revenus exploitation_forestiere
  men$revenu_exploitation_forestiere = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu exploitation_forestiere à 0 pour l'individu courant
    revenu_exploitation_forestiere = 0
    # Associer les revenus si l'activité est "exploitation_forestiere"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Exploitation forestière (bois d'œuvre, planches, piquets)") {
      revenu_exploitation_forestiere = revenu_exploitation_forestiere + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Exploitation forestière (bois d'œuvre, planches, piquets)") {
      revenu_exploitation_forestiere = revenu_exploitation_forestiere + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Exploitation forestière (bois d'œuvre, planches, piquets)") {
      revenu_exploitation_forestiere = revenu_exploitation_forestiere + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus exploitation_forestiere
    men$revenu_exploitation_forestiere[i] = revenu_exploitation_forestiere
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu exploitation_forestiere
  return(men)
}
men = calcul_revenu_exploitation_forestiere(men)
rend_exploitation_forestiere = aggregate (revenu_exploitation_forestiere ~ id, FUN =sum, na.rm=FALSE, data=men)

# 7.2.9 Revenu Employé

calcul_revenu_employe = function(men) {
  # Initialiser une colonne pour stocker les revenus employe
  men$revenu_employe = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu employe à 0 pour l'individu courant
    revenu_employe = 0
    # Associer les revenus si l'activité est "employe"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Employé") {
      revenu_employe = revenu_employe + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Employé") {
      revenu_employe = revenu_employe + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Employé") {
      revenu_employe = revenu_employe + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus employe
    men$revenu_employe[i] = revenu_employe
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu employe
  return(men)
}
men = calcul_revenu_employe(men)
rend_employe = aggregate (revenu_employe ~ id, FUN =sum, na.rm=FALSE, data=men)

# 7.2.10 Revenu Cueillette 

calcul_revenu_cueillette = function(men) {
  # Initialiser une colonne pour stocker les revenus cueillette
  men$revenu_cueillette = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu cueillette à 0 pour l'individu courant
    revenu_cueillette = 0
    # Associer les revenus si l'activité est "cueillette"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Cueillette") {
      revenu_cueillette = revenu_cueillette + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Cueillette") {
      revenu_cueillette = revenu_cueillette + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Cueillette") {
      revenu_cueillette = revenu_cueillette + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus cueillette
    men$revenu_cueillette[i] = revenu_cueillette
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu cueillette
  return(men)
}
men = calcul_revenu_cueillette(men)
rend_cueillette = aggregate (revenu_cueillette ~ id, FUN =sum, na.rm=FALSE, data=men)

# Pour ces id, le revenu lié au vin de palme avait était noté dans "autre"
rend_cueillette$revenu_cueillette[rend_cueillette$id == 916 ] = 3600000 
rend_cueillette$revenu_cueillette[rend_cueillette$id == 1084 ] = 1430000
rend_cueillette$revenu_cueillette[rend_cueillette$id == 1085 ] = 1025000
rend_cueillette$revenu_cueillette[rend_cueillette$id == 1086 ] = 3000000
rend_cueillette$revenu_cueillette[rend_cueillette$id == 1088 ] = 1800000

# 7.2.11 Revenu Chasse 

calcul_revenu_chasse = function(men) {
  # Initialiser une colonne pour stocker les revenus chasse
  men$revenu_chasse = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu chasse à 0 pour l'individu courant
    revenu_chasse = 0
    # Associer les revenus si l'activité est "chasse"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Chasse") {
      revenu_chasse = revenu_chasse + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Chasse") {
      revenu_chasse = revenu_chasse + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Chasse") {
      revenu_chasse = revenu_chasse + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus chasse
    men$revenu_chasse[i] = revenu_chasse
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu chasse
  return(men)
}
men = calcul_revenu_chasse(men)
rend_chasse = aggregate (revenu_chasse ~ id, FUN =sum, na.rm=FALSE, data=men)
rend_chasse$revenu_chasse[rend_chasse$id == 216] = 500000
# Données vérifiées avec les enquêteurs. Les valeurs importantes sont validées


# 7.2.12 Cadre et profession intellectuelle supérieure (instituteur, medecin, infirmier, ingénieur, …)

calcul_revenu_cadre = function(men) {
  # Initialiser une colonne pour stocker les revenus cadre
  men$revenu_cadre = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu cadre à 0 pour l'individu courant
    revenu_cadre = 0
    # Associer les revenus si l'activité est "cadre"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Cadre et profession intellectuelle supérieure (instituteur, medecin, infirmier, ingénieur, …)") {
      revenu_cadre = revenu_cadre + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Cadre et profession intellectuelle supérieure (instituteur, medecin, infirmier, ingénieur, …)") {
      revenu_cadre = revenu_cadre + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Cadre et profession intellectuelle supérieure (instituteur, medecin, infirmier, ingénieur, …)") {
      revenu_cadre = revenu_cadre + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus cadre
    men$revenu_cadre[i] = revenu_cadre
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu cadre
  return(men)
}
men = calcul_revenu_cadre(men)
rend_cadre = aggregate (revenu_cadre ~ id, FUN =sum, na.rm=FALSE, data=men)

# 7.2.13 Revenu Autre

calcul_revenu_autre = function(men) {
  # Initialiser une colonne pour stocker les revenus autre
  men$revenu_autre = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu autre à 0 pour l'individu courant
    revenu_autre = 0
    # Associer les revenus si l'activité est "autre"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Autre") {
      revenu_autre = revenu_autre + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Autre") {
      revenu_autre = revenu_autre + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Autre") {
      revenu_autre = revenu_autre + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus autre
    men$revenu_autre[i] = revenu_autre
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu autre
  return(men)
}
men = calcul_revenu_autre(men)
rend_autre = aggregate (revenu_autre ~ id, FUN =sum, na.rm=FALSE, data=men)
rend_autre$revenu_autre[rend_autre$id == 139 ] = 308000
# Pour 916, 1884,1885,1886,1888 le revenu est lié au vin de palme. Donc je mets 0 et remplace la valeur noté dans le df"rend_cueillette"
rend_autre$revenu_autre[rend_autre$id %in% c(916, 1084, 1085, 1086, 1088)] = 0


# 7.2.13 Revenu Artisanat, boutique, commerce

calcul_revenu_boutique = function(men) {
  # Initialiser une colonne pour stocker les revenus boutique
  men$revenu_boutique = 0
  # Parcourir les individus (lignes) du tableau
  for (i in 1:nrow(men)) {
    # Initialiser le revenu boutique à 0 pour l'individu courant
    revenu_boutique = 0
    # Associer les revenus si l'activité est "boutique"
    if (!is.na (men$activite_1[i]) && men$activite_1[i]  == "Artisanat, petit commerce, petite boutique") {
      revenu_boutique = revenu_boutique + men$revenus_1[i]
    }
    if (!is.na (men$activite_2[i]) && men$activite_2[i]  == "Artisanat, petit commerce, petite boutique") {
      revenu_boutique = revenu_boutique + men$revenus_2[i]
    }
    if (!is.na (men$activite_3[i]) && men$activite_3[i]  == "Artisanat, petit commerce, petite boutique") {
      revenu_boutique = revenu_boutique + men$revenus_3[i]
    }
    # Mettre à jour la colonne des revenus boutique
    men$revenu_boutique[i] = revenu_boutique
  }
  
  # Retourner le tableau de données avec la nouvelle colonne de revenu boutique
  return(men)
}
men = calcul_revenu_boutique(men)
rend_boutique = aggregate (revenu_boutique ~ id, FUN =sum, na.rm=FALSE, data=men)
#id 595 a voir selon réponse de Bruneche


# Création du dataframe "revenu"
rev= merge(rend_agr,rend_bet, by="id", all=TRUE)
rev=merge(rev,rend_char, by="id", all=TRUE)
rev=merge(rev,rend_peche, by="id", all=TRUE)
rev=merge(rev,rend_pisciculture, by="id", all=TRUE)
rev=merge(rev,rend_chasse, by="id", all=TRUE)
rev=merge(rev,rend_cueillette, by="id", all=TRUE)
rev=merge(rev,rend_orpaillage, by="id", all=TRUE)
rev=merge(rev,rend_exploitation_forestiere, by="id", all=TRUE)
rev=merge(rev,rend_boutique, by="id", all=TRUE)
rev=merge(rev,rend_ouvrier, by="id", all=TRUE)
rev=merge(rev,rend_employe, by="id", all=TRUE)
rev=merge(rev,rend_cadre, by="id", all=TRUE)
rev=merge(rev,rend_autre, by="id", all=TRUE)
rev=rev[,c(1,2,5,10:21)]
rev= rev %>% mutate(revenus_totaux = rowSums(across(2:15)))

# write.xlsx(rev, file = "Input_files\\7.2. Revenus totaux.xlsx")

# 8.Facteurs de production------------------------------------------------------

# 8.1. Force de travail

trav = data[, c(732, 469:490)]

names(trav)[c(1:3, 13:19, 21:23)] = c("id", "entraide", "main_doeuvre_ext", "defriche", "preparation_terrain",
                                      "semis", "sarclage", "recolte", "transport", "transformation", "main_oeuvre_permanente",
                                      "main_oeuvre_salarie", "nb_employes")

trav$entraide = as.numeric(trav$entraide == "Oui")
trav$main_doeuvre_ext = as.numeric(trav$main_doeuvre_ext == "Oui")

# write.xlsx(trav[, c(1:3, 5:9, 13:19, 21:23)], file = "Input_files\\8.1. Force de travail.xlsx")


# 8.2. Dynamiques de l'exploitation

dyn = data[, c(732, 491:538)]

dyn$comment_comptez_vous_faire_pour_agrandir_votre_espace_cultive_defrichage_dune_zone_de_savane_527 = 
  dyn$comment_comptez_vous_faire_pour_agrandir_votre_espace_cultive_defrichage_dune_zone_de_savane_527 +
  dyn$comment_comptez_vous_faire_pour_agrandir_votre_espace_cultive_defrichage_dune_zone_de_savane_532

dyn$comment_comptez_vous_faire_pour_agrandir_votre_espace_cultive_defrichage_dune_zone_de_savane_527 = 
  ifelse(dyn$comment_comptez_vous_faire_pour_agrandir_votre_espace_cultive_defrichage_dune_zone_de_savane_527 > 0, 1, 0)

names(dyn)[c(1:2, 4:12, 14, 16:23, 26:33, 36:42, 46:49)] = c("id", "evolution_surf_cult_passe", "aug_achat_chef_terres", "aug_location_chef_terres",
                          "aug_defriche_foret", "aug_defriche_savane", "aug_mariage", "aug_heritage", "aug_affectation_fonciere", "aug_autre",
                          "aug_dons", "evolution_surf_cult_future", "lim_pas_necessite", "lim_absence_terres", "lim_age", "lim_capital",
                          "lim_main_oeuvre", "lim_qual_terres", "lim_insecurite", "lim_autre", "red_age", "red_partage_enf", "red_main_oeuvre",
                          "red_qual_terres", "red_parc_eloignees", "red_animaux", "red_vol", "red_autre", "agrand_achat_chef_terres", "agrand_location_chef_terres",
                          "agrand_defriche_savane", "agrand_mariage", "agrand_heritage", "agrand_autre", "agrand_defriche_foret", "nouv_terres_village",
                          "nouv_terres_district", "nouv_terres_departement", "nouv_terres_autre_departement")


dyn$evolution_surf_cult_future = as.numeric(dyn$evolution_surf_cult_future == "Oui")

# write.xlsx(dyn[c(1:2, 4:10, 12, 14, 16:22, 26:32, 36:40, 42, 46:49)], file = "Input_files\\8.2. Dynamiques de l'exploitation.xlsx")


# 8.3 Equipement

eqpt = data[, c(732, 541:549, 554:562, 564:568, 573:577)]

names(eqpt) = c("id", "tracteur_usage", "motoculteur_usage", "charrue_usage", "herse_usage",
                "butteuse_usage", "motopompe_usage", "batteuse_usage", "tronconneuse_usage",
                "pulverisateur_usage", "tracteur_propriete", "motoculteur_propriete", "butteuse_propriete",
                "charrue_propriete", "herse_propriete", "motopompe_propriete", "batteuse_propriete",
                "tronconneuse_propriete", "pulverisateur_propriete",
                "voiture_usage", "kavaki_usage", "moto_usage", "brouette_usage", "velo_usage",
                "voiture_propriete", "kavaki_propriete", "moto_propriete", "brouette_propriete", "velo_propriete")

eqpt$tracteur_propriete = as.numeric(eqpt$tracteur_propriete == "Propriété pleine" | eqpt$tracteur_propriete == "Propriété partagée")
eqpt$motoculteur_propriete = as.numeric(eqpt$motoculteur_propriete == "Propriété pleine" | eqpt$motoculteur_propriete == "Propriété partagée")
eqpt$butteuse_propriete = as.numeric(eqpt$butteuse_propriete == "Propriété pleine" | eqpt$butteuse_propriete == "Propriété partagée")
eqpt$charrue_propriete = as.numeric(eqpt$charrue_propriete == "Propriété pleine" | eqpt$charrue_propriete == "Propriété partagée")
eqpt$herse_propriete = as.numeric(eqpt$herse_propriete == "Propriété pleine" | eqpt$herse_propriete == "Propriété partagée")
eqpt$motopompe_propriete = as.numeric(eqpt$motopompe_propriete == "Propriété pleine" | eqpt$motopompe_propriete == "Propriété partagée")
eqpt$batteuse_propriete = as.numeric(eqpt$batteuse_propriete == "Propriété pleine" | eqpt$batteuse_propriete == "Propriété partagée")
eqpt$tronconneuse_propriete = as.numeric(eqpt$tronconneuse_propriete == "Propriété pleine" | eqpt$tronconneuse_propriete == "Propriété partagée")
eqpt$pulverisateur_propriete = as.numeric(eqpt$pulverisateur_propriete == "Propriété pleine" | eqpt$pulverisateur_propriete == "Propriété partagée")
eqpt$voiture_propriete = as.numeric(eqpt$voiture_propriete == "Propriété"| eqpt$voiture_propriete == "Propriété en commun")
eqpt$kavaki_propriete = as.numeric(eqpt$kavaki_propriete == "Propriété" | eqpt$kavaki_propriete == "Propriété en commun")
eqpt$moto_propriete = as.numeric(eqpt$moto_propriete == "Propriété" | eqpt$moto_propriete == "Propriété en commun")
eqpt$brouette_propriete = as.numeric(eqpt$brouette_propriete == "Propriété" | eqpt$brouette_propriete == "Propriété en commun")
eqpt$velo_propriete = as.numeric(eqpt$velo_propriete == "Propriété" | eqpt$velo_propriete == "Propriété en commun")

eqpt$eqp_value = 35000000 * eqpt$tracteur_propriete + 300000 * eqpt$motoculteur_propriete + 150 * eqpt$butteuse_propriete +
  5000000 * eqpt$charrue_propriete + 10000000 * eqpt$herse_propriete + 200000 * eqpt$motopompe_propriete + 200 * eqpt$batteuse_propriete +
  200000 * eqpt$tronconneuse_propriete + 45000 * eqpt$pulverisateur_propriete + 5000 * eqpt$voiture_propriete +
  1300000 * eqpt$kavaki_propriete + 500000 * eqpt$moto_propriete + 30000 * eqpt$brouette_propriete + 90000 * eqpt$velo_propriete

# pulverisateur
# moto
# brouette

# write.xlsx(eqpt, file = "Input_files\\8.3 Equipement.xlsx")


# 9. Environnement socio-economique---------------------------------------------

# 9.1. Accompagnement

acc = data[, c(732, 580:582, 584:592, 594:598, 600:605)]

names(acc)[c(1:2)] = c("id", "groupement")

# table(acc$groupement)

acc$groupement = as.numeric(acc$groupement == "Oui, actuellement")

# write.xlsx(acc, file = "Input_files\\9.1. Accompagnement.xlsx")


# 9.2. Contrats

cont = data[, c(732, 606, 608:635, 637, 640:648, 650:655, 657:668)]

names(cont)[c(1:2)] = c("id", "contrat")

cont$contrat = as.numeric(cont$contrat == "Oui")

# write.xlsx(cont, file = "Input_files\\9.2. Contrats.xlsx")


# 9.3. Distance au marché

mar = data[, c(732, 672:678)]

names(mar)[1] = "id"

# write.xlsx(mar, file = "Input_files\\9.3. Distance au marché.xlsx")


# 10. Perspectives--------------------------------------------------------------

per = data[, c(732, 679)]

names(per)= c("id", "reprise")

# write.xlsx(per, file = "Input_files\\10. Perspectives.xlsx")





